<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EV Charging Tracker</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0f172a;
      color: #e2e8f0;
      min-height: 100vh;
    }

    .app-header {
      background: linear-gradient(135deg, #1e3a5f 0%, #0f172a 100%);
      padding: 20px;
      text-align: center;
      border-bottom: 2px solid #22d3ee;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .app-header h1 {
      font-size: 1.5rem;
      color: #22d3ee;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
    }



    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: #1e293b;
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      border: 1px solid #334155;
    }

    .stat-card .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: #22d3ee;
    }

    .stat-card .stat-label {
      font-size: 0.75rem;
      color: #94a3b8;
      margin-top: 4px;
    }

    /* Upload Section */
    .upload-section {
      background: #1e293b;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
      border: 1px solid #334155;
    }

    .upload-section h2 {
      font-size: 1.1rem;
      margin-bottom: 16px;
      color: #22d3ee;
    }

    .upload-area {
      border: 2px dashed #334155;
      border-radius: 12px;
      padding: 40px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
    }

    .upload-area:hover, .upload-area.dragover {
      border-color: #22d3ee;
      background: rgba(34, 211, 238, 0.05);
    }

    .upload-area .upload-icon {
      font-size: 3rem;
      margin-bottom: 12px;
    }

    .upload-area p {
      color: #94a3b8;
      font-size: 0.9rem;
    }

    .upload-area input[type="file"] {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }

    /* Image Preview */
    .image-preview {
      margin-top: 16px;
      display: none;
    }

    .image-preview.show { display: block; }

    .preview-gallery {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .preview-item {
      position: relative;
      width: calc(50% - 5px);
      border-radius: 8px;
      border: 1px solid #334155;
      overflow: hidden;
      background: #0f172a;
    }

    .preview-item img {
      width: 100%;
      height: 150px;
      object-fit: cover;
      display: block;
    }

    .preview-item .btn-remove-img {
      position: absolute;
      top: 6px;
      right: 6px;
      width: 24px;
      height: 24px;
      background: rgba(239, 68, 68, 0.9);
      color: white;
      border: none;
      border-radius: 50%;
      font-size: 14px;
      line-height: 24px;
      text-align: center;
      cursor: pointer;
      padding: 0;
      transition: all 0.2s;
    }

    .preview-item .btn-remove-img:hover {
      background: #ef4444;
      transform: scale(1.1);
    }

    .preview-count {
      font-size: 0.8rem;
      color: #94a3b8;
      margin-top: 8px;
      text-align: center;
    }

    /* Analyze Button */
    .btn-analyze {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #22d3ee, #06b6d4);
      color: #0f172a;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      margin-top: 16px;
      transition: all 0.3s;
      display: none;
    }

    .btn-analyze.show { display: block; }
    .btn-analyze:hover { transform: translateY(-1px); box-shadow: 0 4px 15px rgba(34, 211, 238, 0.3); }
    .btn-analyze:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

    /* Scanning Overlay */
    .scan-overlay {
      display: none;
      margin-top: 16px;
      padding: 24px;
      background: #0f172a;
      border-radius: 12px;
      border: 1px solid #22d3ee;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .scan-overlay.show { display: block; }

    .scan-overlay::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(34, 211, 238, 0.03), transparent);
      animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
      0% { left: -100%; }
      100% { left: 100%; }
    }

    .scan-visual {
      position: relative;
      width: 120px;
      height: 120px;
      margin: 0 auto 20px;
    }

    .scan-ring {
      position: absolute;
      inset: 0;
      border: 3px solid transparent;
      border-top-color: #22d3ee;
      border-radius: 50%;
      animation: scan-spin 1.2s linear infinite;
    }

    .scan-ring:nth-child(2) {
      inset: 10px;
      border-top-color: #06b6d4;
      animation-duration: 1.8s;
      animation-direction: reverse;
    }

    .scan-ring:nth-child(3) {
      inset: 20px;
      border-top-color: #0891b2;
      animation-duration: 2.4s;
    }

    @keyframes scan-spin {
      to { transform: rotate(360deg); }
    }

    .scan-icon {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 2rem;
      animation: scan-pulse 1.5s ease-in-out infinite;
    }

    @keyframes scan-pulse {
      0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
      50% { transform: translate(-50%, -50%) scale(1.15); opacity: 0.7; }
    }

    .scan-steps {
      list-style: none;
      text-align: left;
      max-width: 260px;
      margin: 0 auto;
    }

    .scan-step {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 6px 0;
      font-size: 0.85rem;
      color: #334155;
      transition: all 0.4s;
    }

    .scan-step.active {
      color: #22d3ee;
    }

    .scan-step.done {
      color: #10b981;
    }

    .scan-step-icon {
      width: 20px;
      text-align: center;
      font-size: 0.75rem;
    }

    .scan-step.active .scan-step-icon::after {
      content: '';
      display: inline-block;
      width: 8px;
      height: 8px;
      border: 2px solid #22d3ee;
      border-top-color: transparent;
      border-radius: 50%;
      animation: scan-spin 0.6s linear infinite;
    }

    .scan-dots {
      margin-top: 16px;
      display: flex;
      justify-content: center;
      gap: 6px;
    }

    .scan-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #334155;
      animation: dot-bounce 1.4s ease-in-out infinite;
    }

    .scan-dot:nth-child(2) { animation-delay: 0.2s; }
    .scan-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes dot-bounce {
      0%, 80%, 100% { background: #334155; transform: scale(1); }
      40% { background: #22d3ee; transform: scale(1.4); }
    }

    /* Analysis Result */
    .analysis-result {
      margin-top: 16px;
      padding: 16px;
      background: #0f172a;
      border-radius: 12px;
      border: 1px solid #334155;
      display: none;
    }

    .analysis-result.show {
      display: block;
      animation: result-reveal 0.5s ease-out;
    }

    @keyframes result-reveal {
      0% { opacity: 0; transform: translateY(16px) scale(0.97); }
      60% { transform: translateY(-4px) scale(1.01); }
      100% { opacity: 1; transform: translateY(0) scale(1); }
    }

    .analysis-result.show .result-field {
      animation: field-slide 0.4s ease-out backwards;
    }
    .analysis-result.show .result-field:nth-child(1) { animation-delay: 0.05s; }
    .analysis-result.show .result-field:nth-child(2) { animation-delay: 0.1s; }
    .analysis-result.show .result-field:nth-child(3) { animation-delay: 0.15s; }
    .analysis-result.show .result-field:nth-child(4) { animation-delay: 0.2s; }
    .analysis-result.show .result-field:nth-child(5) { animation-delay: 0.25s; }
    .analysis-result.show .result-field:nth-child(6) { animation-delay: 0.3s; }
    .analysis-result.show .result-field:nth-child(7) { animation-delay: 0.35s; }

    @keyframes field-slide {
      0% { opacity: 0; transform: translateX(-12px); }
      100% { opacity: 1; transform: translateX(0); }
    }

    .analysis-result.show .btn-save {
      animation: save-pop 0.4s ease-out 0.45s backwards;
    }

    @keyframes save-pop {
      0% { opacity: 0; transform: scale(0.8); }
      70% { transform: scale(1.05); }
      100% { opacity: 1; transform: scale(1); }
    }

    .result-field {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid #1e293b;
    }

    .result-field:last-child { border-bottom: none; }

    .result-field label {
      color: #94a3b8;
      font-size: 0.85rem;
    }

    .result-field input {
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 8px;
      color: #e2e8f0;
      padding: 6px 12px;
      font-size: 0.9rem;
      width: 55%;
      text-align: right;
    }

    .result-field input:focus {
      outline: none;
      border-color: #22d3ee;
    }

    .btn-save {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      margin-top: 12px;
      transition: all 0.3s;
    }

    .btn-save:hover { transform: translateY(-1px); box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3); }
    .btn-save:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

    /* History Section */
    .history-section {
      margin-bottom: 20px;
    }

    .history-section h2 {
      font-size: 1.1rem;
      margin-bottom: 16px;
      color: #22d3ee;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .charge-card {
      background: #1e293b;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      border: 1px solid #334155;
      transition: all 0.3s;
    }

    .charge-card:hover { border-color: #22d3ee; }

    .charge-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .charge-card-header .date {
      font-size: 0.85rem;
      color: #94a3b8;
    }

    .charge-card-header .cost {
      font-size: 1.2rem;
      font-weight: 700;
      color: #22d3ee;
    }

    .charge-card-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .charge-detail {
      font-size: 0.8rem;
    }

    .charge-detail .detail-label {
      color: #64748b;
    }

    .charge-detail .detail-value {
      color: #cbd5e1;
      font-weight: 500;
    }

    .charge-card-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 10px;
      gap: 8px;
    }

    .btn-delete {
      background: none;
      border: 1px solid #ef4444;
      color: #ef4444;
      padding: 4px 12px;
      border-radius: 6px;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-delete:hover { background: #ef4444; color: white; }

    /* Loading */
    .loading {
      text-align: center;
      padding: 40px;
      color: #94a3b8;
    }

    .spinner {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 3px solid #334155;
      border-top-color: #22d3ee;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* Settings Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 200;
      padding: 20px;
    }

    .modal-overlay.show { display: flex; }

    .modal {
      background: #1e293b;
      border-radius: 16px;
      padding: 24px;
      width: 100%;
      max-width: 500px;
      border: 1px solid #334155;
    }

    .modal h2 {
      color: #22d3ee;
      margin-bottom: 20px;
      font-size: 1.2rem;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      font-size: 0.85rem;
      color: #94a3b8;
      margin-bottom: 6px;
    }

    .form-group input, .form-group select {
      width: 100%;
      padding: 10px 14px;
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 8px;
      color: #e2e8f0;
      font-size: 0.9rem;
    }

    .form-group input:focus, .form-group select:focus {
      outline: none;
      border-color: #22d3ee;
    }

    .modal-actions {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }

    .modal-actions button {
      flex: 1;
      padding: 12px;
      border-radius: 10px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.3s;
    }

    .btn-cancel {
      background: #334155;
      color: #e2e8f0;
    }

    .btn-confirm {
      background: linear-gradient(135deg, #22d3ee, #06b6d4);
      color: #0f172a;
    }

    .settings-btn {
      background: none;
      border: 1px solid #334155;
      color: #94a3b8;
      padding: 6px 14px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.3s;
    }

    .settings-btn:hover { border-color: #22d3ee; color: #22d3ee; }

    /* Tab Navigation */
    .tab-nav {
      display: flex;
      background: #1e293b;
      border-radius: 12px;
      padding: 4px;
      margin-bottom: 20px;
      border: 1px solid #334155;
    }

    .tab-btn {
      flex: 1;
      padding: 10px;
      background: transparent;
      border: none;
      color: #64748b;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .tab-btn.active {
      background: #0f172a;
      color: #22d3ee;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    .tab-btn svg { width: 16px; height: 16px; }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* Dashboard */
    .dash-section {
      background: #1e293b;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      border: 1px solid #334155;
    }

    .dash-section h3 {
      color: #22d3ee;
      font-size: 0.9rem;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .dash-section h3 .dash-icon {
      font-size: 1rem;
    }

    .chart-container {
      position: relative;
      width: 100%;
      height: 250px;
    }

    .chart-container.tall {
      height: 320px;
    }

    .chart-toggle {
      display: flex;
      gap: 4px;
      margin-bottom: 10px;
    }

    .chart-toggle button {
      flex: 1;
      padding: 6px 10px;
      border: 1px solid #334155;
      background: transparent;
      color: #64748b;
      border-radius: 6px;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .chart-toggle button.active {
      background: #22d3ee;
      color: #0f172a;
      border-color: #22d3ee;
      font-weight: 600;
    }

    .spending-card {
      background: #0f172a;
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 12px;
    }

    .spending-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .spending-nav {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .spending-nav button {
      background: #334155;
      border: none;
      color: #e2e8f0;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      font-size: 1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }

    .spending-nav button:hover {
      background: #475569;
    }

    .spending-nav button:disabled {
      opacity: 0.3;
      cursor: default;
    }

    .spending-title {
      text-align: center;
    }

    .spending-title .label {
      font-size: 0.9rem;
      font-weight: 600;
      color: #e2e8f0;
    }

    .spending-title .date-range {
      font-size: 0.7rem;
      color: #64748b;
      margin-top: 2px;
    }

    .spending-stats {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 8px;
      text-align: center;
    }

    .spending-stat .value {
      font-size: 1.3rem;
      font-weight: 700;
      color: #22d3ee;
    }

    .spending-stat .value.cost {
      color: #f59e0b;
    }

    .spending-stat .unit {
      font-size: 0.65rem;
      color: #64748b;
      margin-top: 2px;
    }

    .donut-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .donut-card {
      text-align: center;
    }

    .donut-card .chart-container {
      height: 180px;
    }

    .donut-label {
      color: #94a3b8;
      font-size: 0.75rem;
      margin-top: 4px;
    }

    .dash-empty {
      text-align: center;
      padding: 40px 20px;
      color: #475569;
    }

    .dash-empty .dash-empty-icon {
      font-size: 2.5rem;
      margin-bottom: 12px;
    }

    .legend-custom {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
      justify-content: center;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 0.7rem;
      color: #94a3b8;
    }

    .legend-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    /* Auth Styles */
    .login-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: calc(100vh - 80px);
      padding: 40px 20px;
      text-align: center;
    }

    .login-screen .login-icon {
      font-size: 4rem;
      margin-bottom: 20px;
    }

    .login-screen h2 {
      color: #22d3ee;
      font-size: 1.3rem;
      margin-bottom: 8px;
    }

    .login-screen p {
      color: #94a3b8;
      font-size: 0.9rem;
      margin-bottom: 32px;
      max-width: 300px;
    }

    .btn-google {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 32px;
      background: white;
      color: #333;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    .btn-google:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.3);
    }

    .btn-google:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .btn-google svg {
      width: 24px;
      height: 24px;
    }

    .user-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #1e293b;
      border-radius: 12px;
      padding: 12px 16px;
      margin-bottom: 20px;
      border: 1px solid #334155;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 2px solid #22d3ee;
    }

    .user-name {
      font-size: 0.85rem;
      color: #e2e8f0;
      font-weight: 500;
    }

    .user-email {
      font-size: 0.7rem;
      color: #64748b;
    }

    .btn-logout {
      background: none;
      border: 1px solid #ef4444;
      color: #ef4444;
      padding: 6px 14px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.3s;
    }

    .btn-logout:hover { background: #ef4444; color: white; }

    .hidden { display: none !important; }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: #10b981;
      color: white;
      padding: 12px 24px;
      border-radius: 10px;
      font-size: 0.9rem;
      font-weight: 500;
      z-index: 300;
      transition: transform 0.3s;
      white-space: nowrap;
    }

    .toast.error { background: #ef4444; }
    .toast.show { transform: translateX(-50%) translateY(0); }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #64748b;
    }

    .empty-state .empty-icon { font-size: 3rem; margin-bottom: 12px; }

    /* Month filter */
    .month-filter {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 16px;
    }

    .month-filter input[type="month"] {
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 8px;
      color: #e2e8f0;
      padding: 8px 12px;
      font-size: 0.85rem;
      flex: 1;
    }

    .month-filter input[type="month"]:focus {
      outline: none;
      border-color: #22d3ee;
    }

    .btn-filter {
      background: #334155;
      border: none;
      color: #e2e8f0;
      padding: 8px 14px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.8rem;
    }

    .btn-filter:hover { background: #475569; }
  </style>
</head>
<body>

  <header class="app-header">
    <h1>
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#22d3ee" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
      EV Charging Tracker
    </h1>
  </header>

  <!-- Auth Loading Screen -->
  <div class="container" id="authLoading">
    <div class="login-screen">
      <div class="spinner"></div>
      <p style="margin-top:16px;color:#94a3b8;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞...</p>
    </div>
  </div>

  <!-- Login Screen -->
  <div class="container hidden" id="loginScreen">
    <div class="login-screen">
      <div class="login-icon">‚ö°</div>
      <h2>EV Charging Tracker</h2>
      <p>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Google ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ä‡∏≤‡∏£‡πå‡∏à‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
      <button class="btn-google" id="btnGoogleLogin" onclick="signInWithGoogle()">
        <svg viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
        ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Google
      </button>
    </div>
  </div>

  <!-- Main App (hidden until logged in) -->
  <div class="container hidden" id="mainApp">

    <!-- User Bar -->
    <div class="user-bar">
      <div class="user-info">
        <img class="user-avatar" id="userAvatar" src="" alt="avatar">
        <div>
          <div class="user-name" id="userName"></div>
          <div class="user-email" id="userEmail"></div>
        </div>
      </div>
      <button class="btn-logout" onclick="signOutUser()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-nav">
      <button class="tab-btn active" onclick="switchTab('home')" id="tabHome">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
        ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
      </button>
      <button class="tab-btn" onclick="switchTab('dashboard')" id="tabDashboard">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
        Dashboard
      </button>
    </div>

    <!-- Home Tab -->
    <div class="tab-content active" id="tabContentHome">

    <!-- Stats -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="totalCharges">0</div>
        <div class="stat-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="totalCost">0 ‡∏ø</div>
        <div class="stat-label">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="totalKwh">0</div>
        <div class="stat-label">kWh ‡∏£‡∏ß‡∏°</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="avgCostPerKwh">0 ‡∏ø</div>
        <div class="stat-label">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ ‡∏ø/kWh</div>
      </div>
    </div>

    <!-- Upload Section -->
    <div class="upload-section">
      <h2>‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡∏≤‡∏£‡∏ä‡∏≤‡∏£‡πå‡∏à</h2>
      <div class="upload-area" id="uploadArea">
        <div class="upload-icon">üì∏</div>
        <p>‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏™‡∏•‡∏¥‡∏õ (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏π‡∏õ)</p>
        <input type="file" id="fileInput" accept="image/*" multiple>
      </div>

      <div class="image-preview" id="imagePreview">
        <div class="preview-gallery" id="previewGallery"></div>
        <div class="preview-count" id="previewCount"></div>
      </div>

      <button class="btn-analyze" id="btnAnalyze" onclick="analyzeSlip()">
        ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏•‡∏¥‡∏õ
      </button>

      <button class="btn-analyze" id="btnAddMore" onclick="document.getElementById('fileInput').click()" style="background:linear-gradient(135deg,#334155,#475569);display:none;">
        + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ‡∏≠‡∏µ‡∏Å
      </button>

      <!-- Scanning Animation -->
      <div class="scan-overlay" id="scanOverlay">
        <div class="scan-visual">
          <div class="scan-ring"></div>
          <div class="scan-ring"></div>
          <div class="scan-ring"></div>
          <div class="scan-icon">ü§ñ</div>
        </div>
        <ul class="scan-steps">
          <li class="scan-step" id="scanStep1"><span class="scan-step-icon"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏£‡∏π‡∏õ‡∏™‡∏•‡∏¥‡∏õ...</li>

          <li class="scan-step" id="scanStep2"><span class="scan-step-icon"></span> AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</li>
          <li class="scan-step" id="scanStep3"><span class="scan-step-icon"></span> ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏™‡∏•‡∏¥‡∏õ...</li>
          <li class="scan-step" id="scanStep4"><span class="scan-step-icon"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå...</li>
        </ul>
        <div class="scan-dots">
          <div class="scan-dot"></div>
          <div class="scan-dot"></div>
          <div class="scan-dot"></div>
        </div>
      </div>

      <!-- Analysis Result -->
      <div class="analysis-result" id="analysisResult">
        <div class="result-field">
          <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏≤‡∏£‡πå‡∏à</label>
          <input type="date" id="resultDate">
        </div>
        <div class="result-field">
          <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ</label>
          <input type="text" id="resultStation" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ">
        </div>
        <div class="result-field">
          <label>‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô (kWh)</label>
          <input type="number" id="resultKwh" step="0.01" placeholder="0.00">
        </div>
        <div class="result-field">
          <label>‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ (‡∏ø)</label>
          <input type="number" id="resultCost" step="0.01" placeholder="0.00">
        </div>
        <div class="result-field">
          <label>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠ kWh (‡∏ø)</label>
          <input type="number" id="resultPricePerKwh" step="0.01" placeholder="0.00" readonly style="color:#22d3ee;background:#0f172a;">
        </div>
        <div class="result-field">
          <label>‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ô‡∏≤‡∏ó‡∏µ)</label>
          <input type="number" id="resultDuration" step="1" placeholder="0">
        </div>
        <div class="result-field">
          <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
          <input type="text" id="resultNote" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)">
        </div>
        <button class="btn-save" id="btnSave" onclick="saveCharge()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
      </div>
    </div>

    <!-- History -->
    <div class="history-section">
      <h2>
        ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ä‡∏≤‡∏£‡πå‡∏à
        <button class="settings-btn" onclick="openSettings()">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
      </h2>

      <div class="month-filter">
        <input type="month" id="monthFilter">
        <button class="btn-filter" onclick="filterByMonth()">‡∏Å‡∏£‡∏≠‡∏á</button>
        <button class="btn-filter" onclick="clearFilter()">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
      </div>

      <div id="chargeList"></div>
    </div>

    </div><!-- end tabContentHome -->

    <!-- Dashboard Tab -->
    <div class="tab-content" id="tabContentDashboard">

      <div id="dashEmpty" class="dash-empty">
        <div class="dash-empty-icon">üìä</div>
        <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚Äî ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ä‡∏≤‡∏£‡πå‡∏à‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π Dashboard</p>
      </div>

      <div id="dashCharts" style="display:none;">

        <!-- Spending Summary -->
        <div class="dash-section">
          <h3><span class="dash-icon">üí∏</span> ‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</h3>

          <!-- Weekly -->
          <div class="spending-card">
            <div class="spending-header">
              <div class="spending-nav">
                <button onclick="navWeek(-1)">‚Äπ</button>
              </div>
              <div class="spending-title">
                <div class="label" id="weekLabel">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ</div>
                <div class="date-range" id="weekDateRange"></div>
              </div>
              <div class="spending-nav">
                <button onclick="navWeek(1)" id="weekNextBtn">‚Ä∫</button>
              </div>
            </div>
            <div class="spending-stats">
              <div class="spending-stat">
                <div class="value cost" id="weekCost">0</div>
                <div class="unit">‡∏ö‡∏≤‡∏ó</div>
              </div>
              <div class="spending-stat">
                <div class="value" id="weekKwh">0</div>
                <div class="unit">kWh</div>
              </div>
              <div class="spending-stat">
                <div class="value" id="weekCount">0</div>
                <div class="unit">‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>
              </div>
            </div>
          </div>

          <!-- Monthly -->
          <div class="spending-card">
            <div class="spending-header">
              <div class="spending-nav">
                <button onclick="navMonth(-1)">‚Äπ</button>
              </div>
              <div class="spending-title">
                <div class="label" id="monthLabel">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>
                <div class="date-range" id="monthDateRange"></div>
              </div>
              <div class="spending-nav">
                <button onclick="navMonth(1)" id="monthNextBtn">‚Ä∫</button>
              </div>
            </div>
            <div class="spending-stats">
              <div class="spending-stat">
                <div class="value cost" id="monthCost">0</div>
                <div class="unit">‡∏ö‡∏≤‡∏ó</div>
              </div>
              <div class="spending-stat">
                <div class="value" id="monthKwh">0</div>
                <div class="unit">kWh</div>
              </div>
              <div class="spending-stat">
                <div class="value" id="monthCount">0</div>
                <div class="unit">‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>
              </div>
            </div>
          </div>
        </div>

        <!-- 1. Usage & Cost Trends -->
        <div class="dash-section">
          <h3><span class="dash-icon">üìà</span> ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Å‡∏≤‡∏£‡∏ä‡∏≤‡∏£‡πå‡∏à‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h3>
          <div class="chart-toggle" id="trendToggle">
            <button class="active" onclick="setTrendMode('kwh')">kWh</button>
            <button onclick="setTrendMode('cost')">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ (‡∏ø)</button>
            <button onclick="setTrendMode('count')">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
          </div>
          <div class="chart-container"><canvas id="chartTrend"></canvas></div>
        </div>

        <!-- 2. Cost per kWh Trend -->
        <div class="dash-section">
          <h3><span class="dash-icon">üí∞</span> ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠ kWh</h3>
          <div class="chart-container"><canvas id="chartCostPerKwh"></canvas></div>
        </div>

        <!-- 3. Day of Week Heatmap -->
        <div class="dash-section">
          <h3><span class="dash-icon">üóìÔ∏è</span> ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏≤‡∏£‡πå‡∏à‡∏ö‡πà‡∏≠‡∏¢</h3>
          <div class="chart-container"><canvas id="chartDayOfWeek"></canvas></div>
        </div>

        <!-- 4. Distribution -->
        <div class="dash-section">
          <h3><span class="dash-icon">üç©</span> ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏ä‡∏≤‡∏£‡πå‡∏à</h3>
          <div class="donut-row">
            <div class="donut-card">
              <div class="donut-label">‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>
              <div class="chart-container"><canvas id="chartStationCount"></canvas></div>
            </div>
            <div class="donut-card">
              <div class="donut-label">‡∏ï‡∏≤‡∏°‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</div>
              <div class="chart-container"><canvas id="chartStationCost"></canvas></div>
            </div>
          </div>
        </div>

        <!-- 6. Avg Duration by Station -->
        <div class="dash-section">
          <h3><span class="dash-icon">‚è±Ô∏è</span> ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ä‡∏≤‡∏£‡πå‡∏à‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (‡∏ô‡∏≤‡∏ó‡∏µ)</h3>
          <div class="chart-container tall"><canvas id="chartDuration"></canvas></div>
        </div>

      </div>
    </div><!-- end tabContentDashboard -->

  </div>

  <!-- Settings Modal -->
  <div class="modal-overlay" id="settingsModal">
    <div class="modal">
      <h2>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</h2>
      <div class="form-group">
        <label>AI Model</label>
        <select id="cfgAiModel">
          <option value="google/gemini-2.5-flash" selected>Gemini 2.5 Flash (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥)</option>
          <option value="google/gemini-2.0-flash-001">Gemini 2.0 Flash</option>
          <option value="openai/gpt-4o-mini">GPT-4o Mini</option>
          <option value="openai/gpt-4o">GPT-4o</option>
          <option value="anthropic/claude-3.5-sonnet">Claude 3.5 Sonnet</option>
        </select>
      </div>
      <div class="modal-actions">
        <button class="btn-cancel" onclick="closeSettings()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button class="btn-confirm" onclick="saveSettings()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-remote-config-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>

  <script>
    // ‚îÄ‚îÄ‚îÄ Firebase Config (hardcoded) ‚îÄ‚îÄ‚îÄ
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyBxKw-XFmKQzOqBHFoCRTPJbMnXVaQR7eo",
      authDomain: "ev-tracker-989cf.firebaseapp.com",
      projectId: "ev-tracker-989cf",
      storageBucket: "ev-tracker-989cf.firebasestorage.app",
      messagingSenderId: "922607274938",
      appId: "1:922607274938:web:66d54af4a68d4fbe98b498"
    };

    // ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ
    let db = null;
    let auth = null;
    let remoteConfig = null;
    let currentUser = null;
    let allCharges = [];
    let currentImagesBase64 = [];
    let config = {};
    let remoteKeys = { openRouterKey: '', aiModel: '' };

    // ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ
    document.addEventListener('DOMContentLoaded', () => {
      loadConfig();
      setupFileInput();
      setDefaultMonth();
      initFirebase();
      document.getElementById('resultCost').addEventListener('input', calcPricePerKwh);
      document.getElementById('resultKwh').addEventListener('input', calcPricePerKwh);
    });

    function loadConfig() {
      const saved = localStorage.getItem('ev_tracker_config');
      if (saved) {
        config = JSON.parse(saved);
      }
    }

    function initFirebase() {
      try {
        if (!firebase.apps.length) {
          firebase.initializeApp(FIREBASE_CONFIG);
        }
        db = firebase.firestore();
        auth = firebase.auth();

        // Init Remote Config
        initRemoteConfig();

        // Listen for auth state changes
        auth.onAuthStateChanged((user) => {
          if (user) {
            currentUser = user;
            showMainApp(user);
            loadCharges();
          } else {
            currentUser = null;
            showLoginScreen();
          }
        });
      } catch (e) {
        showToast('Firebase ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + e.message, true);
      }
    }

    async function initRemoteConfig() {
      try {
        remoteConfig = firebase.remoteConfig();
        remoteConfig.settings.minimumFetchIntervalMillis = 300000; // 5 min cache
        remoteConfig.defaultConfig = {
          openrouter_api_key: '',
          ai_model: ''
        };

        await remoteConfig.fetchAndActivate();
        remoteKeys.openRouterKey = remoteConfig.getString('openrouter_api_key') || '';
        remoteKeys.aiModel = remoteConfig.getString('ai_model') || '';

        if (remoteKeys.openRouterKey) {
          console.log('Remote Config: API key loaded');
          updateSettingsUI();
        }
      } catch (e) {
        console.warn('Remote Config fetch failed, using local config:', e.message);
      }
    }

    function getActiveKey() {
      return remoteKeys.openRouterKey || '';
    }

    function getActiveModel() {
      return remoteKeys.aiModel || config.aiModel || 'google/gemini-2.5-flash';
    }

    // ‚îÄ‚îÄ‚îÄ Auth ‚îÄ‚îÄ‚îÄ
    function signInWithGoogle() {
      const btn = document.getElementById('btnGoogleLogin');
      btn.disabled = true;
      btn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...';

      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider).catch((err) => {
        showToast('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message, true);
        btn.disabled = false;
        btn.innerHTML = '<svg viewBox="0 0 24 24" width="24" height="24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Google';
      });
    }

    function signOutUser() {
      auth.signOut().then(() => {
        showToast('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß');
      });
    }

    function showLoginScreen() {
      document.getElementById('authLoading').classList.add('hidden');
      document.getElementById('loginScreen').classList.remove('hidden');
      document.getElementById('mainApp').classList.add('hidden');
    }

    function showMainApp(user) {
      document.getElementById('authLoading').classList.add('hidden');
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('mainApp').classList.remove('hidden');

      // Update user info
      document.getElementById('userAvatar').src = user.photoURL || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%2394a3b8"><circle cx="12" cy="8" r="4"/><path d="M20 21a8 8 0 1 0-16 0"/></svg>';
      document.getElementById('userName').textContent = user.displayName || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ';
      document.getElementById('userEmail').textContent = user.email || '';

    }

    // ‚îÄ‚îÄ‚îÄ Settings ‚îÄ‚îÄ‚îÄ
    function openSettings() {
      document.getElementById('cfgAiModel').value = config.aiModel || 'google/gemini-2.5-flash';
      document.getElementById('settingsModal').classList.add('show');
    }

    function closeSettings() {
      document.getElementById('settingsModal').classList.remove('show');
    }

    function saveSettings() {
      config = {
        aiModel: document.getElementById('cfgAiModel').value
      };

      localStorage.setItem('ev_tracker_config', JSON.stringify(config));
      closeSettings();
      showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß');
    }

    // ‚îÄ‚îÄ‚îÄ File Input ‚îÄ‚îÄ‚îÄ
    function setupFileInput() {
      const fileInput = document.getElementById('fileInput');
      const uploadArea = document.getElementById('uploadArea');

      fileInput.addEventListener('change', handleFile);

      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
      });

      uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
      });

      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        if (e.dataTransfer.files.length) {
          handleFile({ target: { files: e.dataTransfer.files } });
        }
      });
    }

    function handleFile(e) {
      const files = Array.from(e.target.files);
      if (!files.length) return;

      document.getElementById('analysisResult').classList.remove('show');

      files.forEach(file => {
        const reader = new FileReader();
        reader.onload = (ev) => {
          currentImagesBase64.push(ev.target.result);
          renderPreviewGallery();
          document.getElementById('imagePreview').classList.add('show');
          document.getElementById('btnAnalyze').classList.add('show');
          document.getElementById('btnAddMore').style.display = 'block';
        };
        reader.readAsDataURL(file);
      });
      // Reset file input so the same file can be added again
      if (e.target && e.target.value !== undefined) {
        e.target.value = '';
      }
    }

    function renderPreviewGallery() {
      const gallery = document.getElementById('previewGallery');
      gallery.innerHTML = currentImagesBase64.map((src, idx) => `
        <div class="preview-item">
          <img src="${src}" alt="Preview ${idx + 1}">
          <button class="btn-remove-img" onclick="removeImage(${idx})" title="‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏ô‡∏µ‡πâ">&times;</button>
        </div>
      `).join('');
      document.getElementById('previewCount').textContent = currentImagesBase64.length + ' ‡∏£‡∏π‡∏õ';
    }

    function removeImage(idx) {
      currentImagesBase64.splice(idx, 1);
      if (currentImagesBase64.length === 0) {
        document.getElementById('imagePreview').classList.remove('show');
        document.getElementById('btnAnalyze').classList.remove('show');
        document.getElementById('btnAddMore').style.display = 'none';
        document.getElementById('fileInput').value = '';
      }
      renderPreviewGallery();
    }

    // ‚îÄ‚îÄ‚îÄ OpenRouter AI Analysis ‚îÄ‚îÄ‚îÄ
    async function analyzeSlip() {
      const apiKey = getActiveKey();
      if (!apiKey) {
        showToast('‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° ‚Äî ‡πÑ‡∏°‡πà‡∏û‡∏ö API Key', true);
        return;
      }

      if (currentImagesBase64.length === 0) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡πà‡∏≠‡∏ô', true);
        return;
      }

      const btn = document.getElementById('btnAnalyze');
      btn.disabled = true;
      btn.classList.remove('show');
      document.getElementById('analysisResult').classList.remove('show');

      // Show scan overlay
      const scanOverlay = document.getElementById('scanOverlay');
      scanOverlay.classList.add('show');
      startScanSteps();

      try {
        const model = getActiveModel();

        const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${apiKey}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            model: model,
            messages: [
              {
                role: 'user',
                content: [
                  {
                    type: 'text',
                    text: `‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡∏≤‡∏£‡∏ä‡∏≤‡∏£‡πå‡∏à‡∏£‡∏ñ‡πÑ‡∏ü‡∏ü‡πâ‡∏≤${currentImagesBase64.length > 1 ? '‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ' + currentImagesBase64.length + ' ‡∏£‡∏π‡∏õ ‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å‡∏£‡∏π‡∏õ‡πÄ‡∏Ç‡πâ‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô' : '‡∏ô‡∏µ‡πâ'} ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô JSON ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ markdown ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏∑‡πà‡∏ô
‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô JSON format ‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô:
{
  "date": "YYYY-MM-DD",
  "station": "‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏ä‡∏≤‡∏£‡πå‡∏à",
  "kwh": 0.00,
  "cost": 0.00,
  "duration_minutes": 0,
  "note": "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° ‡πÄ‡∏ä‡πà‡∏ô ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡∏±‡∏ß‡∏ä‡∏≤‡∏£‡πå‡∏à, rate per kWh"
}
‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏´‡∏ô‡πÉ‡∏´‡πâ‡πÉ‡∏™‡πà null ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö string ‡πÅ‡∏•‡∏∞ 0 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö number`
                  },
                  ...currentImagesBase64.map(imgBase64 => ({
                    type: 'image_url',
                    image_url: { url: imgBase64 }
                  }))
                ]
              }
            ]
          })
        });

        if (!response.ok) {
          const errData = await response.json().catch(() => ({}));
          throw new Error(errData.error?.message || `HTTP ${response.status}`);
        }

        const data = await response.json();
        const content = data.choices?.[0]?.message?.content || '';

        // Extract JSON from response
        let jsonStr = content;
        const jsonMatch = content.match(/\{[\s\S]*\}/);
        if (jsonMatch) jsonStr = jsonMatch[0];

        const parsed = JSON.parse(jsonStr);
        await finishScanSteps();
        scanOverlay.classList.remove('show');
        fillResult(parsed);
        showToast('‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏•‡∏¥‡∏õ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');

      } catch (err) {
        stopScanSteps();
        scanOverlay.classList.remove('show');
        showToast('‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message, true);
        console.error(err);
      } finally {
        btn.disabled = false;
        btn.textContent = '‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏•‡∏¥‡∏õ';
        btn.classList.add('show');
        document.getElementById('btnAddMore').style.display = 'none';
      }
    }

    // ‚îÄ‚îÄ‚îÄ Scan Step Animation ‚îÄ‚îÄ‚îÄ
    let scanInterval = null;
    let currentScanStep = 0;

    function startScanSteps() {
      currentScanStep = 0;
      for (let i = 1; i <= 4; i++) {
        const el = document.getElementById('scanStep' + i);
        el.classList.remove('active', 'done');
      }
      document.getElementById('scanStep1').classList.add('active');
      currentScanStep = 1;

      scanInterval = setInterval(() => {
        if (currentScanStep >= 4) {
          clearInterval(scanInterval);
          return;
        }
        document.getElementById('scanStep' + currentScanStep).classList.remove('active');
        document.getElementById('scanStep' + currentScanStep).classList.add('done');
        document.getElementById('scanStep' + currentScanStep).querySelector('.scan-step-icon').textContent = '‚úì';
        currentScanStep++;
        document.getElementById('scanStep' + currentScanStep).classList.add('active');
      }, 1500);
    }

    async function finishScanSteps() {
      clearInterval(scanInterval);
      for (let i = currentScanStep; i <= 4; i++) {
        const el = document.getElementById('scanStep' + i);
        el.classList.remove('active');
        el.classList.add('done');
        el.querySelector('.scan-step-icon').textContent = '‚úì';
        await new Promise(r => setTimeout(r, 200));
      }
      await new Promise(r => setTimeout(r, 400));
    }

    function stopScanSteps() {
      clearInterval(scanInterval);
    }

    function fillResult(data) {
      document.getElementById('resultDate').value = data.date || new Date().toISOString().split('T')[0];
      document.getElementById('resultStation').value = data.station || '';
      document.getElementById('resultKwh').value = data.kwh || 0;
      document.getElementById('resultCost').value = data.cost || 0;
      document.getElementById('resultDuration').value = data.duration_minutes || 0;
      document.getElementById('resultNote').value = data.note || '';
      document.getElementById('analysisResult').classList.add('show');
      calcPricePerKwh();
    }

    function calcPricePerKwh() {
      const cost = parseFloat(document.getElementById('resultCost').value) || 0;
      const kwh = parseFloat(document.getElementById('resultKwh').value) || 0;
      const price = kwh > 0 ? (cost / kwh).toFixed(2) : '0.00';
      document.getElementById('resultPricePerKwh').value = price;
    }

    // ‚îÄ‚îÄ‚îÄ Helper: get user's charges collection ‚îÄ‚îÄ‚îÄ
    function userChargesRef() {
      return db.collection('users').doc(currentUser.uid).collection('charges');
    }

    // ‚îÄ‚îÄ‚îÄ Save to Firestore ‚îÄ‚îÄ‚îÄ
    async function saveCharge() {
      if (!db || !currentUser) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô', true);
        return;
      }

      const btn = document.getElementById('btnSave');
      btn.disabled = true;
      btn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

      try {
        const chargeData = {
          date: document.getElementById('resultDate').value,
          station: document.getElementById('resultStation').value,
          kwh: parseFloat(document.getElementById('resultKwh').value) || 0,
          cost: parseFloat(document.getElementById('resultCost').value) || 0,
          duration: parseInt(document.getElementById('resultDuration').value) || 0,
          note: document.getElementById('resultNote').value,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        await userChargesRef().add(chargeData);
        showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');

        // Reset form
        currentImagesBase64 = [];
        document.getElementById('imagePreview').classList.remove('show');
        document.getElementById('btnAnalyze').classList.remove('show');
        document.getElementById('btnAddMore').style.display = 'none';
        document.getElementById('analysisResult').classList.remove('show');
        document.getElementById('fileInput').value = '';
        document.getElementById('previewGallery').innerHTML = '';
        document.getElementById('previewCount').textContent = '';

        // Reload
        loadCharges();

      } catch (err) {
        showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message, true);
      } finally {
        btn.disabled = false;
        btn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
      }
    }

    // ‚îÄ‚îÄ‚îÄ Load Charges ‚îÄ‚îÄ‚îÄ
    async function loadCharges() {
      if (!db || !currentUser) return;

      const listEl = document.getElementById('chargeList');
      listEl.innerHTML = '<div class="loading"><div class="spinner"></div><p style="margin-top:12px">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p></div>';

      try {
        const snapshot = await userChargesRef().orderBy('date', 'desc').get();
        allCharges = [];

        snapshot.forEach(doc => {
          allCharges.push({ id: doc.id, ...doc.data() });
        });

        renderCharges(allCharges);
        updateStats(allCharges);

        // Refresh dashboard if visible
        if (document.getElementById('tabContentDashboard').classList.contains('active')) {
          buildDashboard(allCharges);
        }

      } catch (err) {
        listEl.innerHTML = `<div class="empty-state"><p>‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${err.message}</p></div>`;
      }
    }

    function renderCharges(charges) {
      const listEl = document.getElementById('chargeList');

      if (charges.length === 0) {
        listEl.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üîå</div>
            <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ä‡∏≤‡∏£‡πå‡∏à</p>
            <p style="margin-top:8px;font-size:0.8rem;">‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</p>
          </div>`;
        return;
      }

      listEl.innerHTML = charges.map(c => `
        <div class="charge-card">
          <div class="charge-card-header">
            <span class="date">${formatDate(c.date)}</span>
            <span class="cost">${formatNumber(c.cost)} ‡∏ø</span>
          </div>
          <div class="charge-card-details">
            <div class="charge-detail">
              <div class="detail-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ</div>
              <div class="detail-value">${escapeHtml(c.station || '-')}</div>
            </div>
            <div class="charge-detail">
              <div class="detail-label">‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô</div>
              <div class="detail-value">${formatNumber(c.kwh)} kWh</div>
            </div>
            <div class="charge-detail">
              <div class="detail-label">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</div>
              <div class="detail-value">${c.duration ? c.duration + ' ‡∏ô‡∏≤‡∏ó‡∏µ' : '-'}</div>
            </div>
            <div class="charge-detail">
              <div class="detail-label">‡∏ø/kWh</div>
              <div class="detail-value">${c.kwh > 0 ? formatNumber(c.cost / c.kwh) : '-'}</div>
            </div>
          </div>
          ${c.note ? `<div style="margin-top:8px;font-size:0.75rem;color:#64748b">${escapeHtml(c.note)}</div>` : ''}
          <div class="charge-card-actions">
            <button class="btn-delete" onclick="deleteCharge('${c.id}')">‡∏•‡∏ö</button>
          </div>
        </div>
      `).join('');
    }

    function updateStats(charges) {
      const total = charges.length;
      const totalCost = charges.reduce((sum, c) => sum + (c.cost || 0), 0);
      const totalKwh = charges.reduce((sum, c) => sum + (c.kwh || 0), 0);
      const avgCost = totalKwh > 0 ? totalCost / totalKwh : 0;

      document.getElementById('totalCharges').textContent = total;
      document.getElementById('totalCost').textContent = formatNumber(totalCost) + ' ‡∏ø';
      document.getElementById('totalKwh').textContent = formatNumber(totalKwh);
      document.getElementById('avgCostPerKwh').textContent = formatNumber(avgCost) + ' ‡∏ø';
    }

    // ‚îÄ‚îÄ‚îÄ Delete ‚îÄ‚îÄ‚îÄ
    async function deleteCharge(id) {
      if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ?')) return;

      try {
        await userChargesRef().doc(id).delete();
        showToast('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß');
        loadCharges();
      } catch (err) {
        showToast('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message, true);
      }
    }

    // ‚îÄ‚îÄ‚îÄ Month Filter ‚îÄ‚îÄ‚îÄ
    function setDefaultMonth() {
      const now = new Date();
      const month = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
      document.getElementById('monthFilter').value = month;
    }

    function filterByMonth() {
      const month = document.getElementById('monthFilter').value;
      if (!month) return;

      const filtered = allCharges.filter(c => c.date && c.date.startsWith(month));
      renderCharges(filtered);
      updateStats(filtered);
    }

    function clearFilter() {
      renderCharges(allCharges);
      updateStats(allCharges);
    }

    // ‚îÄ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ
    function formatDate(dateStr) {
      if (!dateStr) return '-';
      try {
        const d = new Date(dateStr + 'T00:00:00');
        return d.toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric' });
      } catch {
        return dateStr;
      }
    }

    function formatNumber(num) {
      if (typeof num !== 'number' || isNaN(num)) return '0';
      return num.toLocaleString('th-TH', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function showToast(msg, isError = false) {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.className = 'toast' + (isError ? ' error' : '');
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ‚îÄ‚îÄ‚îÄ Tab Navigation ‚îÄ‚îÄ‚îÄ
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function switchTab(tab) {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

      if (tab === 'dashboard') {
        document.getElementById('tabDashboard').classList.add('active');
        document.getElementById('tabContentDashboard').classList.add('active');
        buildDashboard(allCharges);
      } else {
        document.getElementById('tabHome').classList.add('active');
        document.getElementById('tabContentHome').classList.add('active');
      }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ‚îÄ‚îÄ‚îÄ Dashboard ‚îÄ‚îÄ‚îÄ
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const CHART_COLORS = ['#22d3ee', '#f59e0b', '#10b981', '#f472b6', '#a78bfa', '#fb923c', '#34d399', '#60a5fa'];
    let chartInstances = {};
    let currentTrendMode = 'kwh';

    function buildDashboard(charges) {
      if (!charges || charges.length === 0) {
        document.getElementById('dashEmpty').style.display = 'block';
        document.getElementById('dashCharts').style.display = 'none';
        return;
      }
      document.getElementById('dashEmpty').style.display = 'none';
      document.getElementById('dashCharts').style.display = 'block';

      buildSpendingSummary(charges);
      buildTrendChart(charges);
      buildCostPerKwhChart(charges);
      buildDayOfWeekChart(charges);
      buildStationCharts(charges);
      buildDurationChart(charges);
    }

    // ‚îÄ‚îÄ‚îÄ Helper: group by month ‚îÄ‚îÄ‚îÄ
    function groupByMonth(charges) {
      const map = {};
      charges.forEach(c => {
        if (!c.date) return;
        const m = c.date.substring(0, 7); // YYYY-MM
        if (!map[m]) map[m] = [];
        map[m].push(c);
      });
      const keys = Object.keys(map).sort();
      return { keys, map };
    }

    function monthLabel(ym) {
      const [y, m] = ym.split('-');
      const months = ['‡∏°.‡∏Ñ.','‡∏Å.‡∏û.','‡∏°‡∏µ.‡∏Ñ.','‡πÄ‡∏°.‡∏¢.','‡∏û.‡∏Ñ.','‡∏°‡∏¥.‡∏¢.','‡∏Å.‡∏Ñ.','‡∏™.‡∏Ñ.','‡∏Å.‡∏¢.','‡∏ï.‡∏Ñ.','‡∏û.‡∏¢.','‡∏ò.‡∏Ñ.'];
      return months[parseInt(m) - 1] + ' ' + y.slice(2);
    }

    // ‚îÄ‚îÄ‚îÄ 1. Monthly Trend Bar Chart ‚îÄ‚îÄ‚îÄ
    function buildTrendChart(charges) {
      const { keys, map } = groupByMonth(charges);
      const labels = keys.map(monthLabel);

      let data, label, color;
      if (currentTrendMode === 'kwh') {
        data = keys.map(k => map[k].reduce((s, c) => s + (c.kwh || 0), 0));
        label = 'kWh'; color = '#22d3ee';
      } else if (currentTrendMode === 'cost') {
        data = keys.map(k => map[k].reduce((s, c) => s + (c.cost || 0), 0));
        label = '‡∏ö‡∏≤‡∏ó'; color = '#f59e0b';
      } else {
        data = keys.map(k => map[k].length);
        label = '‡∏Ñ‡∏£‡∏±‡πâ‡∏á'; color = '#10b981';
      }

      destroyChart('chartTrend');
      chartInstances['chartTrend'] = new Chart(document.getElementById('chartTrend'), {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label,
            data,
            backgroundColor: color + '99',
            borderColor: color,
            borderWidth: 2,
            borderRadius: 6,
          }]
        },
        options: chartOpts(label)
      });
    }

    function setTrendMode(mode) {
      currentTrendMode = mode;
      document.querySelectorAll('#trendToggle button').forEach(b => b.classList.remove('active'));
      event.target.classList.add('active');
      buildTrendChart(allCharges);
    }

    // ‚îÄ‚îÄ‚îÄ 2. Cost per kWh Line Chart ‚îÄ‚îÄ‚îÄ
    function buildCostPerKwhChart(charges) {
      const { keys, map } = groupByMonth(charges);
      const labels = keys.map(monthLabel);
      const data = keys.map(k => {
        const totalCost = map[k].reduce((s, c) => s + (c.cost || 0), 0);
        const totalKwh = map[k].reduce((s, c) => s + (c.kwh || 0), 0);
        return totalKwh > 0 ? Math.round((totalCost / totalKwh) * 100) / 100 : 0;
      });

      destroyChart('chartCostPerKwh');
      chartInstances['chartCostPerKwh'] = new Chart(document.getElementById('chartCostPerKwh'), {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: '‡∏ø/kWh',
            data,
            borderColor: '#f59e0b',
            backgroundColor: '#f59e0b22',
            fill: true,
            tension: 0.4,
            pointBackgroundColor: '#f59e0b',
            pointRadius: 4,
          }]
        },
        options: chartOpts('‡∏ø/kWh')
      });
    }

    // ‚îÄ‚îÄ‚îÄ 3. Day of Week Bar Chart ‚îÄ‚îÄ‚îÄ
    function buildDayOfWeekChart(charges) {
      const dayNames = ['‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå', '‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå', '‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£', '‡∏û‡∏∏‡∏ò', '‡∏û‡∏§‡∏´‡∏±‡∏™‡∏Ø', '‡∏®‡∏∏‡∏Å‡∏£‡πå', '‡πÄ‡∏™‡∏≤‡∏£‡πå'];
      const counts = [0, 0, 0, 0, 0, 0, 0];
      charges.forEach(c => {
        if (!c.date) return;
        const d = new Date(c.date + 'T00:00:00');
        counts[d.getDay()]++;
      });

      // Reorder: Mon-Sun
      const orderedLabels = [...dayNames.slice(1), dayNames[0]];
      const orderedData = [...counts.slice(1), counts[0]];
      const colors = orderedData.map((v, i) => {
        const max = Math.max(...orderedData);
        const intensity = max > 0 ? v / max : 0;
        return `rgba(34, 211, 238, ${0.2 + intensity * 0.8})`;
      });

      destroyChart('chartDayOfWeek');
      chartInstances['chartDayOfWeek'] = new Chart(document.getElementById('chartDayOfWeek'), {
        type: 'bar',
        data: {
          labels: orderedLabels,
          datasets: [{
            label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
            data: orderedData,
            backgroundColor: colors,
            borderColor: '#22d3ee',
            borderWidth: 1,
            borderRadius: 6,
          }]
        },
        options: chartOpts('‡∏Ñ‡∏£‡∏±‡πâ‡∏á')
      });
    }

    // ‚îÄ‚îÄ‚îÄ Spending Summary (Weekly & Monthly with navigation) ‚îÄ‚îÄ‚îÄ
    let weekOffset = 0;
    let monthOffset = 0;

    function getWeekRange(offset) {
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const dayOfWeek = today.getDay(); // 0=Sun
      const mondayDiff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
      const monday = new Date(today);
      monday.setDate(today.getDate() + mondayDiff + (offset * 7));
      const sunday = new Date(monday);
      sunday.setDate(monday.getDate() + 6);
      return { start: monday, end: sunday };
    }

    function getMonthRange(offset) {
      const now = new Date();
      const year = now.getFullYear();
      const month = now.getMonth() + offset;
      const start = new Date(year, month, 1);
      const end = new Date(year, month + 1, 0);
      return { start, end };
    }

    function formatDateShort(d) {
      return d.toLocaleDateString('th-TH', { day: 'numeric', month: 'short' });
    }

    function formatMonthYear(d) {
      return d.toLocaleDateString('th-TH', { month: 'long', year: 'numeric' });
    }

    function calcSpending(charges, start, end) {
      const startStr = start.toISOString().slice(0, 10);
      const endStr = end.toISOString().slice(0, 10);
      let totalCost = 0, totalKwh = 0, count = 0;
      charges.forEach(c => {
        if (!c.date) return;
        if (c.date >= startStr && c.date <= endStr) {
          totalCost += (c.cost || 0);
          totalKwh += (c.kwh || 0);
          count++;
        }
      });
      return { totalCost, totalKwh, count };
    }

    function buildSpendingSummary(charges) {
      // Weekly
      const weekRange = getWeekRange(weekOffset);
      const weekData = calcSpending(charges, weekRange.start, weekRange.end);
      const weekLabel = weekOffset === 0 ? '‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ' : weekOffset === -1 ? '‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß' : `${Math.abs(weekOffset)} ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Å‡πà‡∏≠‡∏ô`;
      const weekDateRange = `${formatDateShort(weekRange.start)} - ${formatDateShort(weekRange.end)}`;

      document.getElementById('weekLabel').textContent = weekLabel;
      document.getElementById('weekDateRange').textContent = weekDateRange;
      document.getElementById('weekCost').textContent = weekData.totalCost.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      document.getElementById('weekKwh').textContent = weekData.totalKwh.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      document.getElementById('weekCount').textContent = weekData.count;
      document.getElementById('weekNextBtn').disabled = weekOffset >= 0;

      // Monthly
      const monthRange = getMonthRange(monthOffset);
      const monthData = calcSpending(charges, monthRange.start, monthRange.end);
      const monthLabel = monthOffset === 0 ? '‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ' : monthOffset === -1 ? '‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß' : `${Math.abs(monthOffset)} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô`;

      document.getElementById('monthLabel').textContent = monthLabel;
      document.getElementById('monthDateRange').textContent = formatMonthYear(monthRange.start);
      document.getElementById('monthCost').textContent = monthData.totalCost.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      document.getElementById('monthKwh').textContent = monthData.totalKwh.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      document.getElementById('monthCount').textContent = monthData.count;
      document.getElementById('monthNextBtn').disabled = monthOffset >= 0;
    }

    function navWeek(dir) {
      weekOffset += dir;
      if (weekOffset > 0) weekOffset = 0;
      buildSpendingSummary(allCharges);
    }

    function navMonth(dir) {
      monthOffset += dir;
      if (monthOffset > 0) monthOffset = 0;
      buildSpendingSummary(allCharges);
    }

    // ‚îÄ‚îÄ‚îÄ 5. Station Distribution Donut ‚îÄ‚îÄ‚îÄ
    function buildStationCharts(charges) {
      const countMap = {};
      const costMap = {};
      charges.forEach(c => {
        const s = c.station || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
        countMap[s] = (countMap[s] || 0) + 1;
        costMap[s] = (costMap[s] || 0) + (c.cost || 0);
      });

      // Top 6 + others
      const buildDonut = (map, canvasId) => {
        const sorted = Object.entries(map).sort((a, b) => b[1] - a[1]);
        let labels, data;
        if (sorted.length > 6) {
          const top = sorted.slice(0, 6);
          const othersVal = sorted.slice(6).reduce((s, e) => s + e[1], 0);
          labels = [...top.map(e => e[0]), '‡∏≠‡∏∑‡πà‡∏ô‡πÜ'];
          data = [...top.map(e => e[1]), othersVal];
        } else {
          labels = sorted.map(e => e[0]);
          data = sorted.map(e => e[1]);
        }

        destroyChart(canvasId);
        chartInstances[canvasId] = new Chart(document.getElementById(canvasId), {
          type: 'doughnut',
          data: {
            labels,
            datasets: [{
              data,
              backgroundColor: CHART_COLORS.slice(0, labels.length),
              borderColor: '#1e293b',
              borderWidth: 2,
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom',
                labels: { color: '#94a3b8', font: { size: 10 }, boxWidth: 10, padding: 8 }
              }
            },
            cutout: '55%',
          }
        });
      };

      buildDonut(countMap, 'chartStationCount');
      buildDonut(costMap, 'chartStationCost');
    }

    // ‚îÄ‚îÄ‚îÄ 6. Duration by Station (horizontal bar) ‚îÄ‚îÄ‚îÄ
    function buildDurationChart(charges) {
      const durationMap = {};
      const countMap = {};
      charges.forEach(c => {
        if (!c.duration) return;
        const s = c.station || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
        durationMap[s] = (durationMap[s] || 0) + c.duration;
        countMap[s] = (countMap[s] || 0) + 1;
      });

      const entries = Object.keys(durationMap)
        .map(s => ({ station: s, avg: Math.round(durationMap[s] / countMap[s]) }))
        .sort((a, b) => b.avg - a.avg)
        .slice(0, 8);

      if (entries.length === 0) {
        destroyChart('chartDuration');
        return;
      }

      destroyChart('chartDuration');
      chartInstances['chartDuration'] = new Chart(document.getElementById('chartDuration'), {
        type: 'bar',
        data: {
          labels: entries.map(e => e.station),
          datasets: [{
            label: '‡∏ô‡∏≤‡∏ó‡∏µ',
            data: entries.map(e => e.avg),
            backgroundColor: '#a78bfa99',
            borderColor: '#a78bfa',
            borderWidth: 2,
            borderRadius: 6,
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { ticks: { color: '#64748b' }, grid: { color: '#1e293b' } },
            y: {
              ticks: {
                color: '#94a3b8',
                font: { size: 10 },
                callback: function(value) {
                  const label = this.getLabelForValue(value);
                  return label.length > 12 ? label.substring(0, 12) + '‚Ä¶' : label;
                }
              },
              grid: { display: false }
            }
          }
        }
      });
    }

    // ‚îÄ‚îÄ‚îÄ Chart Helpers ‚îÄ‚îÄ‚îÄ
    function destroyChart(id) {
      if (chartInstances[id]) {
        chartInstances[id].destroy();
        delete chartInstances[id];
      }
    }

    function chartOpts(yLabel) {
      return {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false }
        },
        scales: {
          x: { ticks: { color: '#64748b', font: { size: 10 } }, grid: { color: '#1e293b' } },
          y: {
            ticks: { color: '#64748b' },
            grid: { color: '#1e293b' },
            title: { display: true, text: yLabel, color: '#475569', font: { size: 10 } }
          }
        }
      };
    }
  </script>
</body>
</html>
