<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EV Charging Tracker</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0f172a;
      color: #e2e8f0;
      min-height: 100vh;
    }

    .app-header {
      background: linear-gradient(135deg, #1e3a5f 0%, #0f172a 100%);
      padding: 20px;
      text-align: center;
      border-bottom: 2px solid #22d3ee;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .app-header h1 {
      font-size: 1.5rem;
      color: #22d3ee;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Settings Banner */
    .settings-banner {
      background: #1e293b;
      border: 1px solid #f59e0b;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
      display: none;
    }

    .settings-banner.show { display: block; }

    .settings-banner p {
      color: #f59e0b;
      font-size: 0.9rem;
      margin-bottom: 10px;
    }

    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: #1e293b;
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      border: 1px solid #334155;
    }

    .stat-card .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: #22d3ee;
    }

    .stat-card .stat-label {
      font-size: 0.75rem;
      color: #94a3b8;
      margin-top: 4px;
    }

    /* Upload Section */
    .upload-section {
      background: #1e293b;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
      border: 1px solid #334155;
    }

    .upload-section h2 {
      font-size: 1.1rem;
      margin-bottom: 16px;
      color: #22d3ee;
    }

    .upload-area {
      border: 2px dashed #334155;
      border-radius: 12px;
      padding: 40px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
    }

    .upload-area:hover, .upload-area.dragover {
      border-color: #22d3ee;
      background: rgba(34, 211, 238, 0.05);
    }

    .upload-area .upload-icon {
      font-size: 3rem;
      margin-bottom: 12px;
    }

    .upload-area p {
      color: #94a3b8;
      font-size: 0.9rem;
    }

    .upload-area input[type="file"] {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }

    /* Image Preview */
    .image-preview {
      margin-top: 16px;
      display: none;
      text-align: center;
    }

    .image-preview.show { display: block; }

    .image-preview img {
      max-width: 100%;
      max-height: 300px;
      border-radius: 8px;
      border: 1px solid #334155;
    }

    /* Analyze Button */
    .btn-analyze {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #22d3ee, #06b6d4);
      color: #0f172a;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      margin-top: 16px;
      transition: all 0.3s;
      display: none;
    }

    .btn-analyze.show { display: block; }
    .btn-analyze:hover { transform: translateY(-1px); box-shadow: 0 4px 15px rgba(34, 211, 238, 0.3); }
    .btn-analyze:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

    /* Analysis Result */
    .analysis-result {
      margin-top: 16px;
      padding: 16px;
      background: #0f172a;
      border-radius: 12px;
      border: 1px solid #334155;
      display: none;
    }

    .analysis-result.show { display: block; }

    .result-field {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid #1e293b;
    }

    .result-field:last-child { border-bottom: none; }

    .result-field label {
      color: #94a3b8;
      font-size: 0.85rem;
    }

    .result-field input {
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 8px;
      color: #e2e8f0;
      padding: 6px 12px;
      font-size: 0.9rem;
      width: 55%;
      text-align: right;
    }

    .result-field input:focus {
      outline: none;
      border-color: #22d3ee;
    }

    .btn-save {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      margin-top: 12px;
      transition: all 0.3s;
    }

    .btn-save:hover { transform: translateY(-1px); box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3); }
    .btn-save:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

    /* History Section */
    .history-section {
      margin-bottom: 20px;
    }

    .history-section h2 {
      font-size: 1.1rem;
      margin-bottom: 16px;
      color: #22d3ee;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .charge-card {
      background: #1e293b;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      border: 1px solid #334155;
      transition: all 0.3s;
    }

    .charge-card:hover { border-color: #22d3ee; }

    .charge-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .charge-card-header .date {
      font-size: 0.85rem;
      color: #94a3b8;
    }

    .charge-card-header .cost {
      font-size: 1.2rem;
      font-weight: 700;
      color: #22d3ee;
    }

    .charge-card-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .charge-detail {
      font-size: 0.8rem;
    }

    .charge-detail .detail-label {
      color: #64748b;
    }

    .charge-detail .detail-value {
      color: #cbd5e1;
      font-weight: 500;
    }

    .charge-card-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 10px;
      gap: 8px;
    }

    .btn-delete {
      background: none;
      border: 1px solid #ef4444;
      color: #ef4444;
      padding: 4px 12px;
      border-radius: 6px;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-delete:hover { background: #ef4444; color: white; }

    /* Loading */
    .loading {
      text-align: center;
      padding: 40px;
      color: #94a3b8;
    }

    .spinner {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 3px solid #334155;
      border-top-color: #22d3ee;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* Settings Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 200;
      padding: 20px;
    }

    .modal-overlay.show { display: flex; }

    .modal {
      background: #1e293b;
      border-radius: 16px;
      padding: 24px;
      width: 100%;
      max-width: 500px;
      border: 1px solid #334155;
    }

    .modal h2 {
      color: #22d3ee;
      margin-bottom: 20px;
      font-size: 1.2rem;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      font-size: 0.85rem;
      color: #94a3b8;
      margin-bottom: 6px;
    }

    .form-group input, .form-group select {
      width: 100%;
      padding: 10px 14px;
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 8px;
      color: #e2e8f0;
      font-size: 0.9rem;
    }

    .form-group input:focus, .form-group select:focus {
      outline: none;
      border-color: #22d3ee;
    }

    .modal-actions {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }

    .modal-actions button {
      flex: 1;
      padding: 12px;
      border-radius: 10px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.3s;
    }

    .btn-cancel {
      background: #334155;
      color: #e2e8f0;
    }

    .btn-confirm {
      background: linear-gradient(135deg, #22d3ee, #06b6d4);
      color: #0f172a;
    }

    .settings-btn {
      background: none;
      border: 1px solid #334155;
      color: #94a3b8;
      padding: 6px 14px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.3s;
    }

    .settings-btn:hover { border-color: #22d3ee; color: #22d3ee; }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: #10b981;
      color: white;
      padding: 12px 24px;
      border-radius: 10px;
      font-size: 0.9rem;
      font-weight: 500;
      z-index: 300;
      transition: transform 0.3s;
      white-space: nowrap;
    }

    .toast.error { background: #ef4444; }
    .toast.show { transform: translateX(-50%) translateY(0); }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #64748b;
    }

    .empty-state .empty-icon { font-size: 3rem; margin-bottom: 12px; }

    /* Month filter */
    .month-filter {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 16px;
    }

    .month-filter input[type="month"] {
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 8px;
      color: #e2e8f0;
      padding: 8px 12px;
      font-size: 0.85rem;
      flex: 1;
    }

    .month-filter input[type="month"]:focus {
      outline: none;
      border-color: #22d3ee;
    }

    .btn-filter {
      background: #334155;
      border: none;
      color: #e2e8f0;
      padding: 8px 14px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.8rem;
    }

    .btn-filter:hover { background: #475569; }
  </style>
</head>
<body>

  <header class="app-header">
    <h1>
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#22d3ee" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
      EV Charging Tracker
    </h1>
  </header>

  <div class="container">

    <!-- Settings Banner -->
    <div class="settings-banner" id="settingsBanner">
      <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ API Key ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
      <button class="settings-btn" onclick="openSettings()">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
    </div>

    <!-- Stats -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="totalCharges">0</div>
        <div class="stat-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="totalCost">0 ‡∏ø</div>
        <div class="stat-label">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="totalKwh">0</div>
        <div class="stat-label">kWh ‡∏£‡∏ß‡∏°</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="avgCostPerKwh">0 ‡∏ø</div>
        <div class="stat-label">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ ‡∏ø/kWh</div>
      </div>
    </div>

    <!-- Upload Section -->
    <div class="upload-section">
      <h2>‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡∏≤‡∏£‡∏ä‡∏≤‡∏£‡πå‡∏à</h2>
      <div class="upload-area" id="uploadArea">
        <div class="upload-icon">üì∏</div>
        <p>‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏™‡∏•‡∏¥‡∏õ</p>
        <input type="file" id="fileInput" accept="image/*" capture="environment">
      </div>

      <div class="image-preview" id="imagePreview">
        <img id="previewImg" src="" alt="Preview">
      </div>

      <button class="btn-analyze" id="btnAnalyze" onclick="analyzeSlip()">
        ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏•‡∏¥‡∏õ
      </button>

      <!-- Analysis Result -->
      <div class="analysis-result" id="analysisResult">
        <div class="result-field">
          <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏≤‡∏£‡πå‡∏à</label>
          <input type="date" id="resultDate">
        </div>
        <div class="result-field">
          <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ</label>
          <input type="text" id="resultStation" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ">
        </div>
        <div class="result-field">
          <label>‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô (kWh)</label>
          <input type="number" id="resultKwh" step="0.01" placeholder="0.00">
        </div>
        <div class="result-field">
          <label>‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ (‡∏ø)</label>
          <input type="number" id="resultCost" step="0.01" placeholder="0.00">
        </div>
        <div class="result-field">
          <label>‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ô‡∏≤‡∏ó‡∏µ)</label>
          <input type="number" id="resultDuration" step="1" placeholder="0">
        </div>
        <div class="result-field">
          <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
          <input type="text" id="resultNote" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)">
        </div>
        <button class="btn-save" id="btnSave" onclick="saveCharge()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
      </div>
    </div>

    <!-- History -->
    <div class="history-section">
      <h2>
        ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ä‡∏≤‡∏£‡πå‡∏à
        <button class="settings-btn" onclick="openSettings()">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
      </h2>

      <div class="month-filter">
        <input type="month" id="monthFilter">
        <button class="btn-filter" onclick="filterByMonth()">‡∏Å‡∏£‡∏≠‡∏á</button>
        <button class="btn-filter" onclick="clearFilter()">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
      </div>

      <div id="chargeList"></div>
    </div>

  </div>

  <!-- Settings Modal -->
  <div class="modal-overlay" id="settingsModal">
    <div class="modal">
      <h2>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</h2>
      <div class="form-group">
        <label>Firebase API Key</label>
        <input type="text" id="cfgFirebaseApiKey" placeholder="AIza...">
      </div>
      <div class="form-group">
        <label>Firebase Auth Domain</label>
        <input type="text" id="cfgFirebaseAuthDomain" placeholder="your-app.firebaseapp.com">
      </div>
      <div class="form-group">
        <label>Firebase Project ID</label>
        <input type="text" id="cfgFirebaseProjectId" placeholder="your-project-id">
      </div>
      <div class="form-group">
        <label>Firebase Storage Bucket</label>
        <input type="text" id="cfgFirebaseStorageBucket" placeholder="your-app.appspot.com">
      </div>
      <div class="form-group">
        <label>Firebase Messaging Sender ID</label>
        <input type="text" id="cfgFirebaseMessagingSenderId" placeholder="123456789">
      </div>
      <div class="form-group">
        <label>Firebase App ID</label>
        <input type="text" id="cfgFirebaseAppId" placeholder="1:123456789:web:abc123">
      </div>
      <div class="form-group">
        <label>OpenRouter API Key</label>
        <input type="password" id="cfgOpenRouterKey" placeholder="sk-or-...">
      </div>
      <div class="form-group">
        <label>AI Model</label>
        <select id="cfgAiModel">
          <option value="google/gemini-2.0-flash-001">Gemini 2.0 Flash (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥)</option>
          <option value="openai/gpt-4o-mini">GPT-4o Mini</option>
          <option value="openai/gpt-4o">GPT-4o</option>
          <option value="anthropic/claude-3.5-sonnet">Claude 3.5 Sonnet</option>
        </select>
      </div>
      <div class="modal-actions">
        <button class="btn-cancel" onclick="closeSettings()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button class="btn-confirm" onclick="saveSettings()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <script>
    // ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ
    let db = null;
    let allCharges = [];
    let currentImageBase64 = null;
    let config = {};

    // ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ
    document.addEventListener('DOMContentLoaded', () => {
      loadConfig();
      setupFileInput();
      setDefaultMonth();
    });

    function loadConfig() {
      const saved = localStorage.getItem('ev_tracker_config');
      if (saved) {
        config = JSON.parse(saved);
        initFirebase();
      } else {
        document.getElementById('settingsBanner').classList.add('show');
      }
    }

    function initFirebase() {
      if (!config.firebaseApiKey || !config.firebaseProjectId) {
        document.getElementById('settingsBanner').classList.add('show');
        return;
      }

      const firebaseConfig = {
        apiKey: config.firebaseApiKey,
        authDomain: config.firebaseAuthDomain || '',
        projectId: config.firebaseProjectId,
        storageBucket: config.firebaseStorageBucket || '',
        messagingSenderId: config.firebaseMessagingSenderId || '',
        appId: config.firebaseAppId || ''
      };

      try {
        if (!firebase.apps.length) {
          firebase.initializeApp(firebaseConfig);
        }
        db = firebase.firestore();
        document.getElementById('settingsBanner').classList.remove('show');
        loadCharges();
      } catch (e) {
        showToast('Firebase ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + e.message, true);
      }
    }

    // ‚îÄ‚îÄ‚îÄ Settings ‚îÄ‚îÄ‚îÄ
    function openSettings() {
      document.getElementById('cfgFirebaseApiKey').value = config.firebaseApiKey || '';
      document.getElementById('cfgFirebaseAuthDomain').value = config.firebaseAuthDomain || '';
      document.getElementById('cfgFirebaseProjectId').value = config.firebaseProjectId || '';
      document.getElementById('cfgFirebaseStorageBucket').value = config.firebaseStorageBucket || '';
      document.getElementById('cfgFirebaseMessagingSenderId').value = config.firebaseMessagingSenderId || '';
      document.getElementById('cfgFirebaseAppId').value = config.firebaseAppId || '';
      document.getElementById('cfgOpenRouterKey').value = config.openRouterKey || '';
      document.getElementById('cfgAiModel').value = config.aiModel || 'google/gemini-2.0-flash-001';
      document.getElementById('settingsModal').classList.add('show');
    }

    function closeSettings() {
      document.getElementById('settingsModal').classList.remove('show');
    }

    function saveSettings() {
      config = {
        firebaseApiKey: document.getElementById('cfgFirebaseApiKey').value.trim(),
        firebaseAuthDomain: document.getElementById('cfgFirebaseAuthDomain').value.trim(),
        firebaseProjectId: document.getElementById('cfgFirebaseProjectId').value.trim(),
        firebaseStorageBucket: document.getElementById('cfgFirebaseStorageBucket').value.trim(),
        firebaseMessagingSenderId: document.getElementById('cfgFirebaseMessagingSenderId').value.trim(),
        firebaseAppId: document.getElementById('cfgFirebaseAppId').value.trim(),
        openRouterKey: document.getElementById('cfgOpenRouterKey').value.trim(),
        aiModel: document.getElementById('cfgAiModel').value
      };

      localStorage.setItem('ev_tracker_config', JSON.stringify(config));
      closeSettings();
      showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß');

      // Re-init firebase
      if (firebase.apps.length) {
        firebase.app().delete().then(() => {
          initFirebase();
        });
      } else {
        initFirebase();
      }
    }

    // ‚îÄ‚îÄ‚îÄ File Input ‚îÄ‚îÄ‚îÄ
    function setupFileInput() {
      const fileInput = document.getElementById('fileInput');
      const uploadArea = document.getElementById('uploadArea');

      fileInput.addEventListener('change', handleFile);

      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
      });

      uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
      });

      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        if (e.dataTransfer.files.length) {
          fileInput.files = e.dataTransfer.files;
          handleFile({ target: fileInput });
        }
      });
    }

    function handleFile(e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (ev) => {
        currentImageBase64 = ev.target.result;
        document.getElementById('previewImg').src = currentImageBase64;
        document.getElementById('imagePreview').classList.add('show');
        document.getElementById('btnAnalyze').classList.add('show');
        document.getElementById('analysisResult').classList.remove('show');
      };
      reader.readAsDataURL(file);
    }

    // ‚îÄ‚îÄ‚îÄ OpenRouter AI Analysis ‚îÄ‚îÄ‚îÄ
    async function analyzeSlip() {
      if (!config.openRouterKey) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ OpenRouter API Key ‡∏Å‡πà‡∏≠‡∏ô', true);
        openSettings();
        return;
      }

      if (!currentImageBase64) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡πà‡∏≠‡∏ô', true);
        return;
      }

      const btn = document.getElementById('btnAnalyze');
      btn.disabled = true;
      btn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...';

      try {
        const model = config.aiModel || 'google/gemini-2.0-flash-001';

        const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${config.openRouterKey}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            model: model,
            messages: [
              {
                role: 'user',
                content: [
                  {
                    type: 'text',
                    text: `‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡∏≤‡∏£‡∏ä‡∏≤‡∏£‡πå‡∏à‡∏£‡∏ñ‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏ô‡∏µ‡πâ ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô JSON ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ markdown ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏∑‡πà‡∏ô
‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô JSON format ‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô:
{
  "date": "YYYY-MM-DD",
  "station": "‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏ä‡∏≤‡∏£‡πå‡∏à",
  "kwh": 0.00,
  "cost": 0.00,
  "duration_minutes": 0,
  "note": "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° ‡πÄ‡∏ä‡πà‡∏ô ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡∏±‡∏ß‡∏ä‡∏≤‡∏£‡πå‡∏à, rate per kWh"
}
‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏´‡∏ô‡πÉ‡∏´‡πâ‡πÉ‡∏™‡πà null ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö string ‡πÅ‡∏•‡∏∞ 0 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö number`
                  },
                  {
                    type: 'image_url',
                    image_url: { url: currentImageBase64 }
                  }
                ]
              }
            ]
          })
        });

        if (!response.ok) {
          const errData = await response.json().catch(() => ({}));
          throw new Error(errData.error?.message || `HTTP ${response.status}`);
        }

        const data = await response.json();
        const content = data.choices?.[0]?.message?.content || '';

        // Extract JSON from response
        let jsonStr = content;
        const jsonMatch = content.match(/\{[\s\S]*\}/);
        if (jsonMatch) jsonStr = jsonMatch[0];

        const parsed = JSON.parse(jsonStr);
        fillResult(parsed);
        showToast('‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏•‡∏¥‡∏õ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');

      } catch (err) {
        showToast('‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message, true);
        console.error(err);
      } finally {
        btn.disabled = false;
        btn.textContent = '‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏•‡∏¥‡∏õ';
      }
    }

    function fillResult(data) {
      document.getElementById('resultDate').value = data.date || new Date().toISOString().split('T')[0];
      document.getElementById('resultStation').value = data.station || '';
      document.getElementById('resultKwh').value = data.kwh || 0;
      document.getElementById('resultCost').value = data.cost || 0;
      document.getElementById('resultDuration').value = data.duration_minutes || 0;
      document.getElementById('resultNote').value = data.note || '';
      document.getElementById('analysisResult').classList.add('show');
    }

    // ‚îÄ‚îÄ‚îÄ Save to Firestore ‚îÄ‚îÄ‚îÄ
    async function saveCharge() {
      if (!db) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Firebase ‡∏Å‡πà‡∏≠‡∏ô', true);
        return;
      }

      const btn = document.getElementById('btnSave');
      btn.disabled = true;
      btn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

      try {
        const chargeData = {
          date: document.getElementById('resultDate').value,
          station: document.getElementById('resultStation').value,
          kwh: parseFloat(document.getElementById('resultKwh').value) || 0,
          cost: parseFloat(document.getElementById('resultCost').value) || 0,
          duration: parseInt(document.getElementById('resultDuration').value) || 0,
          note: document.getElementById('resultNote').value,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        await db.collection('charges').add(chargeData);
        showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');

        // Reset form
        currentImageBase64 = null;
        document.getElementById('imagePreview').classList.remove('show');
        document.getElementById('btnAnalyze').classList.remove('show');
        document.getElementById('analysisResult').classList.remove('show');
        document.getElementById('fileInput').value = '';

        // Reload
        loadCharges();

      } catch (err) {
        showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message, true);
      } finally {
        btn.disabled = false;
        btn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
      }
    }

    // ‚îÄ‚îÄ‚îÄ Load Charges ‚îÄ‚îÄ‚îÄ
    async function loadCharges() {
      if (!db) return;

      const listEl = document.getElementById('chargeList');
      listEl.innerHTML = '<div class="loading"><div class="spinner"></div><p style="margin-top:12px">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p></div>';

      try {
        const snapshot = await db.collection('charges').orderBy('date', 'desc').get();
        allCharges = [];

        snapshot.forEach(doc => {
          allCharges.push({ id: doc.id, ...doc.data() });
        });

        renderCharges(allCharges);
        updateStats(allCharges);

      } catch (err) {
        listEl.innerHTML = `<div class="empty-state"><p>‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${err.message}</p></div>`;
      }
    }

    function renderCharges(charges) {
      const listEl = document.getElementById('chargeList');

      if (charges.length === 0) {
        listEl.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üîå</div>
            <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ä‡∏≤‡∏£‡πå‡∏à</p>
            <p style="margin-top:8px;font-size:0.8rem;">‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</p>
          </div>`;
        return;
      }

      listEl.innerHTML = charges.map(c => `
        <div class="charge-card">
          <div class="charge-card-header">
            <span class="date">${formatDate(c.date)}</span>
            <span class="cost">${formatNumber(c.cost)} ‡∏ø</span>
          </div>
          <div class="charge-card-details">
            <div class="charge-detail">
              <div class="detail-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ</div>
              <div class="detail-value">${escapeHtml(c.station || '-')}</div>
            </div>
            <div class="charge-detail">
              <div class="detail-label">‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô</div>
              <div class="detail-value">${formatNumber(c.kwh)} kWh</div>
            </div>
            <div class="charge-detail">
              <div class="detail-label">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</div>
              <div class="detail-value">${c.duration ? c.duration + ' ‡∏ô‡∏≤‡∏ó‡∏µ' : '-'}</div>
            </div>
            <div class="charge-detail">
              <div class="detail-label">‡∏ø/kWh</div>
              <div class="detail-value">${c.kwh > 0 ? formatNumber(c.cost / c.kwh) : '-'}</div>
            </div>
          </div>
          ${c.note ? `<div style="margin-top:8px;font-size:0.75rem;color:#64748b">${escapeHtml(c.note)}</div>` : ''}
          <div class="charge-card-actions">
            <button class="btn-delete" onclick="deleteCharge('${c.id}')">‡∏•‡∏ö</button>
          </div>
        </div>
      `).join('');
    }

    function updateStats(charges) {
      const total = charges.length;
      const totalCost = charges.reduce((sum, c) => sum + (c.cost || 0), 0);
      const totalKwh = charges.reduce((sum, c) => sum + (c.kwh || 0), 0);
      const avgCost = totalKwh > 0 ? totalCost / totalKwh : 0;

      document.getElementById('totalCharges').textContent = total;
      document.getElementById('totalCost').textContent = formatNumber(totalCost) + ' ‡∏ø';
      document.getElementById('totalKwh').textContent = formatNumber(totalKwh);
      document.getElementById('avgCostPerKwh').textContent = formatNumber(avgCost) + ' ‡∏ø';
    }

    // ‚îÄ‚îÄ‚îÄ Delete ‚îÄ‚îÄ‚îÄ
    async function deleteCharge(id) {
      if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ?')) return;

      try {
        await db.collection('charges').doc(id).delete();
        showToast('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß');
        loadCharges();
      } catch (err) {
        showToast('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message, true);
      }
    }

    // ‚îÄ‚îÄ‚îÄ Month Filter ‚îÄ‚îÄ‚îÄ
    function setDefaultMonth() {
      const now = new Date();
      const month = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
      document.getElementById('monthFilter').value = month;
    }

    function filterByMonth() {
      const month = document.getElementById('monthFilter').value;
      if (!month) return;

      const filtered = allCharges.filter(c => c.date && c.date.startsWith(month));
      renderCharges(filtered);
      updateStats(filtered);
    }

    function clearFilter() {
      renderCharges(allCharges);
      updateStats(allCharges);
    }

    // ‚îÄ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ
    function formatDate(dateStr) {
      if (!dateStr) return '-';
      try {
        const d = new Date(dateStr + 'T00:00:00');
        return d.toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric' });
      } catch {
        return dateStr;
      }
    }

    function formatNumber(num) {
      if (typeof num !== 'number' || isNaN(num)) return '0';
      return num.toLocaleString('th-TH', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function showToast(msg, isError = false) {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.className = 'toast' + (isError ? ' error' : '');
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }
  </script>
</body>
</html>
