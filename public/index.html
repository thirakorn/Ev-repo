<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EV Charging Tracker</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0f172a;
      color: #e2e8f0;
      min-height: 100vh;
    }

    .app-header {
      background: linear-gradient(135deg, #1e3a5f 0%, #0f172a 100%);
      padding: 20px;
      text-align: center;
      border-bottom: 2px solid #22d3ee;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .app-header h1 {
      font-size: 1.5rem;
      color: #22d3ee;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Settings Banner */
    .settings-banner {
      background: #1e293b;
      border: 1px solid #f59e0b;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
      display: none;
    }

    .settings-banner.show { display: block; }

    .settings-banner p {
      color: #f59e0b;
      font-size: 0.9rem;
      margin-bottom: 10px;
    }

    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: #1e293b;
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      border: 1px solid #334155;
    }

    .stat-card .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: #22d3ee;
    }

    .stat-card .stat-label {
      font-size: 0.75rem;
      color: #94a3b8;
      margin-top: 4px;
    }

    /* Upload Section */
    .upload-section {
      background: #1e293b;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
      border: 1px solid #334155;
    }

    .upload-section h2 {
      font-size: 1.1rem;
      margin-bottom: 16px;
      color: #22d3ee;
    }

    .upload-area {
      border: 2px dashed #334155;
      border-radius: 12px;
      padding: 40px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
    }

    .upload-area:hover, .upload-area.dragover {
      border-color: #22d3ee;
      background: rgba(34, 211, 238, 0.05);
    }

    .upload-area .upload-icon {
      font-size: 3rem;
      margin-bottom: 12px;
    }

    .upload-area p {
      color: #94a3b8;
      font-size: 0.9rem;
    }

    .upload-area input[type="file"] {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }

    /* Image Preview */
    .image-preview {
      margin-top: 16px;
      display: none;
      text-align: center;
    }

    .image-preview.show { display: block; }

    .image-preview img {
      max-width: 100%;
      max-height: 300px;
      border-radius: 8px;
      border: 1px solid #334155;
    }

    /* Analyze Button */
    .btn-analyze {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #22d3ee, #06b6d4);
      color: #0f172a;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      margin-top: 16px;
      transition: all 0.3s;
      display: none;
    }

    .btn-analyze.show { display: block; }
    .btn-analyze:hover { transform: translateY(-1px); box-shadow: 0 4px 15px rgba(34, 211, 238, 0.3); }
    .btn-analyze:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

    /* Scanning Overlay */
    .scan-overlay {
      display: none;
      margin-top: 16px;
      padding: 24px;
      background: #0f172a;
      border-radius: 12px;
      border: 1px solid #22d3ee;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .scan-overlay.show { display: block; }

    .scan-overlay::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(34, 211, 238, 0.03), transparent);
      animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
      0% { left: -100%; }
      100% { left: 100%; }
    }

    .scan-visual {
      position: relative;
      width: 120px;
      height: 120px;
      margin: 0 auto 20px;
    }

    .scan-ring {
      position: absolute;
      inset: 0;
      border: 3px solid transparent;
      border-top-color: #22d3ee;
      border-radius: 50%;
      animation: scan-spin 1.2s linear infinite;
    }

    .scan-ring:nth-child(2) {
      inset: 10px;
      border-top-color: #06b6d4;
      animation-duration: 1.8s;
      animation-direction: reverse;
    }

    .scan-ring:nth-child(3) {
      inset: 20px;
      border-top-color: #0891b2;
      animation-duration: 2.4s;
    }

    @keyframes scan-spin {
      to { transform: rotate(360deg); }
    }

    .scan-icon {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 2rem;
      animation: scan-pulse 1.5s ease-in-out infinite;
    }

    @keyframes scan-pulse {
      0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
      50% { transform: translate(-50%, -50%) scale(1.15); opacity: 0.7; }
    }

    .scan-steps {
      list-style: none;
      text-align: left;
      max-width: 260px;
      margin: 0 auto;
    }

    .scan-step {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 6px 0;
      font-size: 0.85rem;
      color: #334155;
      transition: all 0.4s;
    }

    .scan-step.active {
      color: #22d3ee;
    }

    .scan-step.done {
      color: #10b981;
    }

    .scan-step-icon {
      width: 20px;
      text-align: center;
      font-size: 0.75rem;
    }

    .scan-step.active .scan-step-icon::after {
      content: '';
      display: inline-block;
      width: 8px;
      height: 8px;
      border: 2px solid #22d3ee;
      border-top-color: transparent;
      border-radius: 50%;
      animation: scan-spin 0.6s linear infinite;
    }

    .scan-dots {
      margin-top: 16px;
      display: flex;
      justify-content: center;
      gap: 6px;
    }

    .scan-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #334155;
      animation: dot-bounce 1.4s ease-in-out infinite;
    }

    .scan-dot:nth-child(2) { animation-delay: 0.2s; }
    .scan-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes dot-bounce {
      0%, 80%, 100% { background: #334155; transform: scale(1); }
      40% { background: #22d3ee; transform: scale(1.4); }
    }

    /* Analysis Result */
    .analysis-result {
      margin-top: 16px;
      padding: 16px;
      background: #0f172a;
      border-radius: 12px;
      border: 1px solid #334155;
      display: none;
    }

    .analysis-result.show {
      display: block;
      animation: result-reveal 0.5s ease-out;
    }

    @keyframes result-reveal {
      0% { opacity: 0; transform: translateY(16px) scale(0.97); }
      60% { transform: translateY(-4px) scale(1.01); }
      100% { opacity: 1; transform: translateY(0) scale(1); }
    }

    .analysis-result.show .result-field {
      animation: field-slide 0.4s ease-out backwards;
    }
    .analysis-result.show .result-field:nth-child(1) { animation-delay: 0.05s; }
    .analysis-result.show .result-field:nth-child(2) { animation-delay: 0.1s; }
    .analysis-result.show .result-field:nth-child(3) { animation-delay: 0.15s; }
    .analysis-result.show .result-field:nth-child(4) { animation-delay: 0.2s; }
    .analysis-result.show .result-field:nth-child(5) { animation-delay: 0.25s; }
    .analysis-result.show .result-field:nth-child(6) { animation-delay: 0.3s; }
    .analysis-result.show .result-field:nth-child(7) { animation-delay: 0.35s; }

    @keyframes field-slide {
      0% { opacity: 0; transform: translateX(-12px); }
      100% { opacity: 1; transform: translateX(0); }
    }

    .analysis-result.show .btn-save {
      animation: save-pop 0.4s ease-out 0.45s backwards;
    }

    @keyframes save-pop {
      0% { opacity: 0; transform: scale(0.8); }
      70% { transform: scale(1.05); }
      100% { opacity: 1; transform: scale(1); }
    }

    .result-field {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid #1e293b;
    }

    .result-field:last-child { border-bottom: none; }

    .result-field label {
      color: #94a3b8;
      font-size: 0.85rem;
    }

    .result-field input {
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 8px;
      color: #e2e8f0;
      padding: 6px 12px;
      font-size: 0.9rem;
      width: 55%;
      text-align: right;
    }

    .result-field input:focus {
      outline: none;
      border-color: #22d3ee;
    }

    .btn-save {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      margin-top: 12px;
      transition: all 0.3s;
    }

    .btn-save:hover { transform: translateY(-1px); box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3); }
    .btn-save:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

    /* History Section */
    .history-section {
      margin-bottom: 20px;
    }

    .history-section h2 {
      font-size: 1.1rem;
      margin-bottom: 16px;
      color: #22d3ee;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .charge-card {
      background: #1e293b;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      border: 1px solid #334155;
      transition: all 0.3s;
    }

    .charge-card:hover { border-color: #22d3ee; }

    .charge-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .charge-card-header .date {
      font-size: 0.85rem;
      color: #94a3b8;
    }

    .charge-card-header .cost {
      font-size: 1.2rem;
      font-weight: 700;
      color: #22d3ee;
    }

    .charge-card-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .charge-detail {
      font-size: 0.8rem;
    }

    .charge-detail .detail-label {
      color: #64748b;
    }

    .charge-detail .detail-value {
      color: #cbd5e1;
      font-weight: 500;
    }

    .charge-card-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 10px;
      gap: 8px;
    }

    .btn-delete {
      background: none;
      border: 1px solid #ef4444;
      color: #ef4444;
      padding: 4px 12px;
      border-radius: 6px;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-delete:hover { background: #ef4444; color: white; }

    /* Loading */
    .loading {
      text-align: center;
      padding: 40px;
      color: #94a3b8;
    }

    .spinner {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 3px solid #334155;
      border-top-color: #22d3ee;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* Settings Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 200;
      padding: 20px;
    }

    .modal-overlay.show { display: flex; }

    .modal {
      background: #1e293b;
      border-radius: 16px;
      padding: 24px;
      width: 100%;
      max-width: 500px;
      border: 1px solid #334155;
    }

    .modal h2 {
      color: #22d3ee;
      margin-bottom: 20px;
      font-size: 1.2rem;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      font-size: 0.85rem;
      color: #94a3b8;
      margin-bottom: 6px;
    }

    .form-group input, .form-group select {
      width: 100%;
      padding: 10px 14px;
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 8px;
      color: #e2e8f0;
      font-size: 0.9rem;
    }

    .form-group input:focus, .form-group select:focus {
      outline: none;
      border-color: #22d3ee;
    }

    .modal-actions {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }

    .modal-actions button {
      flex: 1;
      padding: 12px;
      border-radius: 10px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.3s;
    }

    .btn-cancel {
      background: #334155;
      color: #e2e8f0;
    }

    .btn-confirm {
      background: linear-gradient(135deg, #22d3ee, #06b6d4);
      color: #0f172a;
    }

    .settings-btn {
      background: none;
      border: 1px solid #334155;
      color: #94a3b8;
      padding: 6px 14px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.3s;
    }

    .settings-btn:hover { border-color: #22d3ee; color: #22d3ee; }

    /* Auth Styles */
    .login-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: calc(100vh - 80px);
      padding: 40px 20px;
      text-align: center;
    }

    .login-screen .login-icon {
      font-size: 4rem;
      margin-bottom: 20px;
    }

    .login-screen h2 {
      color: #22d3ee;
      font-size: 1.3rem;
      margin-bottom: 8px;
    }

    .login-screen p {
      color: #94a3b8;
      font-size: 0.9rem;
      margin-bottom: 32px;
      max-width: 300px;
    }

    .btn-google {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 32px;
      background: white;
      color: #333;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    .btn-google:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.3);
    }

    .btn-google:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .btn-google svg {
      width: 24px;
      height: 24px;
    }

    .user-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #1e293b;
      border-radius: 12px;
      padding: 12px 16px;
      margin-bottom: 20px;
      border: 1px solid #334155;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 2px solid #22d3ee;
    }

    .user-name {
      font-size: 0.85rem;
      color: #e2e8f0;
      font-weight: 500;
    }

    .user-email {
      font-size: 0.7rem;
      color: #64748b;
    }

    .btn-logout {
      background: none;
      border: 1px solid #ef4444;
      color: #ef4444;
      padding: 6px 14px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.3s;
    }

    .btn-logout:hover { background: #ef4444; color: white; }

    .hidden { display: none !important; }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: #10b981;
      color: white;
      padding: 12px 24px;
      border-radius: 10px;
      font-size: 0.9rem;
      font-weight: 500;
      z-index: 300;
      transition: transform 0.3s;
      white-space: nowrap;
    }

    .toast.error { background: #ef4444; }
    .toast.show { transform: translateX(-50%) translateY(0); }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #64748b;
    }

    .empty-state .empty-icon { font-size: 3rem; margin-bottom: 12px; }

    /* Month filter */
    .month-filter {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 16px;
    }

    .month-filter input[type="month"] {
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 8px;
      color: #e2e8f0;
      padding: 8px 12px;
      font-size: 0.85rem;
      flex: 1;
    }

    .month-filter input[type="month"]:focus {
      outline: none;
      border-color: #22d3ee;
    }

    .btn-filter {
      background: #334155;
      border: none;
      color: #e2e8f0;
      padding: 8px 14px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.8rem;
    }

    .btn-filter:hover { background: #475569; }
  </style>
</head>
<body>

  <header class="app-header">
    <h1>
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#22d3ee" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
      EV Charging Tracker
    </h1>
  </header>

  <!-- Auth Loading Screen -->
  <div class="container" id="authLoading">
    <div class="login-screen">
      <div class="spinner"></div>
      <p style="margin-top:16px;color:#94a3b8;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞...</p>
    </div>
  </div>

  <!-- Login Screen -->
  <div class="container hidden" id="loginScreen">
    <div class="login-screen">
      <div class="login-icon">‚ö°</div>
      <h2>EV Charging Tracker</h2>
      <p>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Google ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ä‡∏≤‡∏£‡πå‡∏à‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
      <button class="btn-google" id="btnGoogleLogin" onclick="signInWithGoogle()">
        <svg viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
        ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Google
      </button>
    </div>
  </div>

  <!-- Main App (hidden until logged in) -->
  <div class="container hidden" id="mainApp">

    <!-- User Bar -->
    <div class="user-bar">
      <div class="user-info">
        <img class="user-avatar" id="userAvatar" src="" alt="avatar">
        <div>
          <div class="user-name" id="userName"></div>
          <div class="user-email" id="userEmail"></div>
        </div>
      </div>
      <button class="btn-logout" onclick="signOutUser()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>

    <!-- Stats -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="totalCharges">0</div>
        <div class="stat-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="totalCost">0 ‡∏ø</div>
        <div class="stat-label">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="totalKwh">0</div>
        <div class="stat-label">kWh ‡∏£‡∏ß‡∏°</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="avgCostPerKwh">0 ‡∏ø</div>
        <div class="stat-label">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ ‡∏ø/kWh</div>
      </div>
    </div>

    <!-- Upload Section -->
    <div class="upload-section">
      <h2>‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡∏≤‡∏£‡∏ä‡∏≤‡∏£‡πå‡∏à</h2>
      <div class="upload-area" id="uploadArea">
        <div class="upload-icon">üì∏</div>
        <p>‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏™‡∏•‡∏¥‡∏õ</p>
        <input type="file" id="fileInput" accept="image/*" capture="environment">
      </div>

      <div class="image-preview" id="imagePreview">
        <img id="previewImg" src="" alt="Preview">
      </div>

      <button class="btn-analyze" id="btnAnalyze" onclick="analyzeSlip()">
        ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏•‡∏¥‡∏õ
      </button>

      <!-- Scanning Animation -->
      <div class="scan-overlay" id="scanOverlay">
        <div class="scan-visual">
          <div class="scan-ring"></div>
          <div class="scan-ring"></div>
          <div class="scan-ring"></div>
          <div class="scan-icon">ü§ñ</div>
        </div>
        <ul class="scan-steps">
          <li class="scan-step" id="scanStep1"><span class="scan-step-icon"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏£‡∏π‡∏õ‡∏™‡∏•‡∏¥‡∏õ...</li>
          <li class="scan-step" id="scanStep2"><span class="scan-step-icon"></span> AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</li>
          <li class="scan-step" id="scanStep3"><span class="scan-step-icon"></span> ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏™‡∏•‡∏¥‡∏õ...</li>
          <li class="scan-step" id="scanStep4"><span class="scan-step-icon"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå...</li>
        </ul>
        <div class="scan-dots">
          <div class="scan-dot"></div>
          <div class="scan-dot"></div>
          <div class="scan-dot"></div>
        </div>
      </div>

      <!-- Analysis Result -->
      <div class="analysis-result" id="analysisResult">
        <div class="result-field">
          <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏≤‡∏£‡πå‡∏à</label>
          <input type="date" id="resultDate">
        </div>
        <div class="result-field">
          <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ</label>
          <input type="text" id="resultStation" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ">
        </div>
        <div class="result-field">
          <label>‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô (kWh)</label>
          <input type="number" id="resultKwh" step="0.01" placeholder="0.00">
        </div>
        <div class="result-field">
          <label>‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ (‡∏ø)</label>
          <input type="number" id="resultCost" step="0.01" placeholder="0.00">
        </div>
        <div class="result-field">
          <label>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠ kWh (‡∏ø)</label>
          <input type="number" id="resultPricePerKwh" step="0.01" placeholder="0.00" readonly style="color:#22d3ee;background:#0f172a;">
        </div>
        <div class="result-field">
          <label>‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ô‡∏≤‡∏ó‡∏µ)</label>
          <input type="number" id="resultDuration" step="1" placeholder="0">
        </div>
        <div class="result-field">
          <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
          <input type="text" id="resultNote" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)">
        </div>
        <button class="btn-save" id="btnSave" onclick="saveCharge()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
      </div>
    </div>

    <!-- History -->
    <div class="history-section">
      <h2>
        ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ä‡∏≤‡∏£‡πå‡∏à
        <button class="settings-btn" onclick="openSettings()">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
      </h2>

      <div class="month-filter">
        <input type="month" id="monthFilter">
        <button class="btn-filter" onclick="filterByMonth()">‡∏Å‡∏£‡∏≠‡∏á</button>
        <button class="btn-filter" onclick="clearFilter()">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
      </div>

      <div id="chargeList"></div>
    </div>

  </div>

  <!-- Settings Modal -->
  <div class="modal-overlay" id="settingsModal">
    <div class="modal">
      <h2>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</h2>
      <div id="remoteConfigBadge" style="display:none; background:#064e3b; color:#6ee7b7; padding:8px 12px; border-radius:8px; font-size:0.8rem; margin-bottom:12px; text-align:center;">
        ‡πÉ‡∏ä‡πâ API Key ‡∏à‡∏≤‡∏Å Remote Config
      </div>
      <div class="form-group">
        <label>OpenRouter API Key <span id="keySourceLabel" style="font-size:0.7rem; color:#64748b;"></span></label>
        <input type="password" id="cfgOpenRouterKey" placeholder="sk-or-...">
        <small id="keyHint" style="color:#64748b; font-size:0.7rem;"></small>
      </div>
      <div class="form-group">
        <label>AI Model <span id="modelSourceLabel" style="font-size:0.7rem; color:#64748b;"></span></label>
        <select id="cfgAiModel">
          <option value="google/gemini-2.5-flash" selected>Gemini 2.5 Flash (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥)</option>
          <option value="google/gemini-2.0-flash-001">Gemini 2.0 Flash</option>
          <option value="openai/gpt-4o-mini">GPT-4o Mini</option>
          <option value="openai/gpt-4o">GPT-4o</option>
          <option value="anthropic/claude-3.5-sonnet">Claude 3.5 Sonnet</option>
        </select>
      </div>
      <div class="modal-actions">
        <button class="btn-cancel" onclick="closeSettings()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button class="btn-confirm" onclick="saveSettings()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-remote-config-compat.js"></script>

  <script>
    // ‚îÄ‚îÄ‚îÄ Firebase Config (hardcoded) ‚îÄ‚îÄ‚îÄ
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyBxKw-XFmKQzOqBHFoCRTPJbMnXVaQR7eo",
      authDomain: "ev-tracker-989cf.firebaseapp.com",
      projectId: "ev-tracker-989cf",
      storageBucket: "ev-tracker-989cf.firebasestorage.app",
      messagingSenderId: "922607274938",
      appId: "1:922607274938:web:66d54af4a68d4fbe98b498"
    };

    // ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ
    let db = null;
    let auth = null;
    let remoteConfig = null;
    let currentUser = null;
    let allCharges = [];
    let currentImageBase64 = null;
    let config = {};
    let remoteKeys = { openRouterKey: '', aiModel: '' };

    // ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ
    document.addEventListener('DOMContentLoaded', () => {
      loadConfig();
      setupFileInput();
      setDefaultMonth();
      initFirebase();
      document.getElementById('resultCost').addEventListener('input', calcPricePerKwh);
      document.getElementById('resultKwh').addEventListener('input', calcPricePerKwh);
    });

    function loadConfig() {
      const saved = localStorage.getItem('ev_tracker_config');
      if (saved) {
        config = JSON.parse(saved);
      }
    }

    function initFirebase() {
      try {
        if (!firebase.apps.length) {
          firebase.initializeApp(FIREBASE_CONFIG);
        }
        db = firebase.firestore();
        auth = firebase.auth();

        // Init Remote Config
        initRemoteConfig();

        // Listen for auth state changes
        auth.onAuthStateChanged((user) => {
          if (user) {
            currentUser = user;
            showMainApp(user);
            loadCharges();
          } else {
            currentUser = null;
            showLoginScreen();
          }
        });
      } catch (e) {
        showToast('Firebase ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + e.message, true);
      }
    }

    async function initRemoteConfig() {
      try {
        remoteConfig = firebase.remoteConfig();
        remoteConfig.settings.minimumFetchIntervalMillis = 300000; // 5 min cache
        remoteConfig.defaultConfig = {
          openrouter_api_key: '',
          ai_model: ''
        };

        await remoteConfig.fetchAndActivate();
        remoteKeys.openRouterKey = remoteConfig.getString('openrouter_api_key') || '';
        remoteKeys.aiModel = remoteConfig.getString('ai_model') || '';

        if (remoteKeys.openRouterKey) {
          console.log('Remote Config: API key loaded');
          updateSettingsUI();
        }
      } catch (e) {
        console.warn('Remote Config fetch failed, using local config:', e.message);
      }
    }

    function getActiveKey() {
      return remoteKeys.openRouterKey || config.openRouterKey || '';
    }

    function getActiveModel() {
      return remoteKeys.aiModel || config.aiModel || 'google/gemini-2.5-flash';
    }

    // ‚îÄ‚îÄ‚îÄ Auth ‚îÄ‚îÄ‚îÄ
    function signInWithGoogle() {
      const btn = document.getElementById('btnGoogleLogin');
      btn.disabled = true;
      btn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...';

      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider).catch((err) => {
        showToast('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message, true);
        btn.disabled = false;
        btn.innerHTML = '<svg viewBox="0 0 24 24" width="24" height="24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Google';
      });
    }

    function signOutUser() {
      auth.signOut().then(() => {
        showToast('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß');
      });
    }

    function showLoginScreen() {
      document.getElementById('authLoading').classList.add('hidden');
      document.getElementById('loginScreen').classList.remove('hidden');
      document.getElementById('mainApp').classList.add('hidden');
    }

    function showMainApp(user) {
      document.getElementById('authLoading').classList.add('hidden');
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('mainApp').classList.remove('hidden');

      // Update user info
      document.getElementById('userAvatar').src = user.photoURL || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%2394a3b8"><circle cx="12" cy="8" r="4"/><path d="M20 21a8 8 0 1 0-16 0"/></svg>';
      document.getElementById('userName').textContent = user.displayName || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ';
      document.getElementById('userEmail').textContent = user.email || '';

      // Check if OpenRouter key is set (local or remote)
      if (!getActiveKey()) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ OpenRouter API Key', true);
      }
    }

    // ‚îÄ‚îÄ‚îÄ Settings (OpenRouter only) ‚îÄ‚îÄ‚îÄ
    function openSettings() {
      document.getElementById('cfgOpenRouterKey').value = config.openRouterKey || '';
      document.getElementById('cfgAiModel').value = config.aiModel || 'google/gemini-2.5-flash';
      updateSettingsUI();
      document.getElementById('settingsModal').classList.add('show');
    }

    function updateSettingsUI() {
      const badge = document.getElementById('remoteConfigBadge');
      const keyHint = document.getElementById('keyHint');
      const keyLabel = document.getElementById('keySourceLabel');
      const modelLabel = document.getElementById('modelSourceLabel');

      if (remoteKeys.openRouterKey) {
        badge.style.display = 'block';
        keyHint.textContent = 'Remote Config ‡∏°‡∏µ key ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‚Äî ‡∏Å‡∏£‡∏≠‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠ override';
        keyLabel.textContent = '(Remote Config)';
      } else {
        badge.style.display = 'none';
        keyHint.textContent = '';
        keyLabel.textContent = '';
      }

      if (remoteKeys.aiModel) {
        modelLabel.textContent = '(Remote Config: ' + remoteKeys.aiModel + ')';
      } else {
        modelLabel.textContent = '';
      }
    }

    function closeSettings() {
      document.getElementById('settingsModal').classList.remove('show');
    }

    function saveSettings() {
      config = {
        openRouterKey: document.getElementById('cfgOpenRouterKey').value.trim(),
        aiModel: document.getElementById('cfgAiModel').value
      };

      localStorage.setItem('ev_tracker_config', JSON.stringify(config));
      closeSettings();
      showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß');
    }

    // ‚îÄ‚îÄ‚îÄ File Input ‚îÄ‚îÄ‚îÄ
    function setupFileInput() {
      const fileInput = document.getElementById('fileInput');
      const uploadArea = document.getElementById('uploadArea');

      fileInput.addEventListener('change', handleFile);

      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
      });

      uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
      });

      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        if (e.dataTransfer.files.length) {
          fileInput.files = e.dataTransfer.files;
          handleFile({ target: fileInput });
        }
      });
    }

    function handleFile(e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (ev) => {
        currentImageBase64 = ev.target.result;
        document.getElementById('previewImg').src = currentImageBase64;
        document.getElementById('imagePreview').classList.add('show');
        document.getElementById('btnAnalyze').classList.add('show');
        document.getElementById('analysisResult').classList.remove('show');
      };
      reader.readAsDataURL(file);
    }

    // ‚îÄ‚îÄ‚îÄ OpenRouter AI Analysis ‚îÄ‚îÄ‚îÄ
    async function analyzeSlip() {
      const apiKey = getActiveKey();
      if (!apiKey) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ OpenRouter API Key ‡∏Å‡πà‡∏≠‡∏ô', true);
        openSettings();
        return;
      }

      if (!currentImageBase64) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡πà‡∏≠‡∏ô', true);
        return;
      }

      const btn = document.getElementById('btnAnalyze');
      btn.disabled = true;
      btn.classList.remove('show');
      document.getElementById('analysisResult').classList.remove('show');

      // Show scan overlay
      const scanOverlay = document.getElementById('scanOverlay');
      scanOverlay.classList.add('show');
      startScanSteps();

      try {
        const model = getActiveModel();

        const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${apiKey}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            model: model,
            messages: [
              {
                role: 'user',
                content: [
                  {
                    type: 'text',
                    text: `‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡∏≤‡∏£‡∏ä‡∏≤‡∏£‡πå‡∏à‡∏£‡∏ñ‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏ô‡∏µ‡πâ ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô JSON ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ markdown ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏∑‡πà‡∏ô
‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô JSON format ‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô:
{
  "date": "YYYY-MM-DD",
  "station": "‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏ä‡∏≤‡∏£‡πå‡∏à",
  "kwh": 0.00,
  "cost": 0.00,
  "duration_minutes": 0,
  "note": "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° ‡πÄ‡∏ä‡πà‡∏ô ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡∏±‡∏ß‡∏ä‡∏≤‡∏£‡πå‡∏à, rate per kWh"
}
‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏´‡∏ô‡πÉ‡∏´‡πâ‡πÉ‡∏™‡πà null ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö string ‡πÅ‡∏•‡∏∞ 0 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö number`
                  },
                  {
                    type: 'image_url',
                    image_url: { url: currentImageBase64 }
                  }
                ]
              }
            ]
          })
        });

        if (!response.ok) {
          const errData = await response.json().catch(() => ({}));
          throw new Error(errData.error?.message || `HTTP ${response.status}`);
        }

        const data = await response.json();
        const content = data.choices?.[0]?.message?.content || '';

        // Extract JSON from response
        let jsonStr = content;
        const jsonMatch = content.match(/\{[\s\S]*\}/);
        if (jsonMatch) jsonStr = jsonMatch[0];

        const parsed = JSON.parse(jsonStr);
        await finishScanSteps();
        scanOverlay.classList.remove('show');
        fillResult(parsed);
        showToast('‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏•‡∏¥‡∏õ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');

      } catch (err) {
        stopScanSteps();
        scanOverlay.classList.remove('show');
        showToast('‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message, true);
        console.error(err);
      } finally {
        btn.disabled = false;
        btn.textContent = '‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏•‡∏¥‡∏õ';
        btn.classList.add('show');
      }
    }

    // ‚îÄ‚îÄ‚îÄ Scan Step Animation ‚îÄ‚îÄ‚îÄ
    let scanInterval = null;
    let currentScanStep = 0;

    function startScanSteps() {
      currentScanStep = 0;
      for (let i = 1; i <= 4; i++) {
        const el = document.getElementById('scanStep' + i);
        el.classList.remove('active', 'done');
      }
      document.getElementById('scanStep1').classList.add('active');
      currentScanStep = 1;

      scanInterval = setInterval(() => {
        if (currentScanStep >= 4) {
          clearInterval(scanInterval);
          return;
        }
        document.getElementById('scanStep' + currentScanStep).classList.remove('active');
        document.getElementById('scanStep' + currentScanStep).classList.add('done');
        document.getElementById('scanStep' + currentScanStep).querySelector('.scan-step-icon').textContent = '‚úì';
        currentScanStep++;
        document.getElementById('scanStep' + currentScanStep).classList.add('active');
      }, 1500);
    }

    async function finishScanSteps() {
      clearInterval(scanInterval);
      for (let i = currentScanStep; i <= 4; i++) {
        const el = document.getElementById('scanStep' + i);
        el.classList.remove('active');
        el.classList.add('done');
        el.querySelector('.scan-step-icon').textContent = '‚úì';
        await new Promise(r => setTimeout(r, 200));
      }
      await new Promise(r => setTimeout(r, 400));
    }

    function stopScanSteps() {
      clearInterval(scanInterval);
    }

    function fillResult(data) {
      document.getElementById('resultDate').value = data.date || new Date().toISOString().split('T')[0];
      document.getElementById('resultStation').value = data.station || '';
      document.getElementById('resultKwh').value = data.kwh || 0;
      document.getElementById('resultCost').value = data.cost || 0;
      document.getElementById('resultDuration').value = data.duration_minutes || 0;
      document.getElementById('resultNote').value = data.note || '';
      document.getElementById('analysisResult').classList.add('show');
      calcPricePerKwh();
    }

    function calcPricePerKwh() {
      const cost = parseFloat(document.getElementById('resultCost').value) || 0;
      const kwh = parseFloat(document.getElementById('resultKwh').value) || 0;
      const price = kwh > 0 ? (cost / kwh).toFixed(2) : '0.00';
      document.getElementById('resultPricePerKwh').value = price;
    }

    // ‚îÄ‚îÄ‚îÄ Helper: get user's charges collection ‚îÄ‚îÄ‚îÄ
    function userChargesRef() {
      return db.collection('users').doc(currentUser.uid).collection('charges');
    }

    // ‚îÄ‚îÄ‚îÄ Save to Firestore ‚îÄ‚îÄ‚îÄ
    async function saveCharge() {
      if (!db || !currentUser) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô', true);
        return;
      }

      const btn = document.getElementById('btnSave');
      btn.disabled = true;
      btn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

      try {
        const chargeData = {
          date: document.getElementById('resultDate').value,
          station: document.getElementById('resultStation').value,
          kwh: parseFloat(document.getElementById('resultKwh').value) || 0,
          cost: parseFloat(document.getElementById('resultCost').value) || 0,
          duration: parseInt(document.getElementById('resultDuration').value) || 0,
          note: document.getElementById('resultNote').value,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        await userChargesRef().add(chargeData);
        showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');

        // Reset form
        currentImageBase64 = null;
        document.getElementById('imagePreview').classList.remove('show');
        document.getElementById('btnAnalyze').classList.remove('show');
        document.getElementById('analysisResult').classList.remove('show');
        document.getElementById('fileInput').value = '';

        // Reload
        loadCharges();

      } catch (err) {
        showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message, true);
      } finally {
        btn.disabled = false;
        btn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
      }
    }

    // ‚îÄ‚îÄ‚îÄ Load Charges ‚îÄ‚îÄ‚îÄ
    async function loadCharges() {
      if (!db || !currentUser) return;

      const listEl = document.getElementById('chargeList');
      listEl.innerHTML = '<div class="loading"><div class="spinner"></div><p style="margin-top:12px">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p></div>';

      try {
        const snapshot = await userChargesRef().orderBy('date', 'desc').get();
        allCharges = [];

        snapshot.forEach(doc => {
          allCharges.push({ id: doc.id, ...doc.data() });
        });

        renderCharges(allCharges);
        updateStats(allCharges);

      } catch (err) {
        listEl.innerHTML = `<div class="empty-state"><p>‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${err.message}</p></div>`;
      }
    }

    function renderCharges(charges) {
      const listEl = document.getElementById('chargeList');

      if (charges.length === 0) {
        listEl.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üîå</div>
            <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ä‡∏≤‡∏£‡πå‡∏à</p>
            <p style="margin-top:8px;font-size:0.8rem;">‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</p>
          </div>`;
        return;
      }

      listEl.innerHTML = charges.map(c => `
        <div class="charge-card">
          <div class="charge-card-header">
            <span class="date">${formatDate(c.date)}</span>
            <span class="cost">${formatNumber(c.cost)} ‡∏ø</span>
          </div>
          <div class="charge-card-details">
            <div class="charge-detail">
              <div class="detail-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ</div>
              <div class="detail-value">${escapeHtml(c.station || '-')}</div>
            </div>
            <div class="charge-detail">
              <div class="detail-label">‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô</div>
              <div class="detail-value">${formatNumber(c.kwh)} kWh</div>
            </div>
            <div class="charge-detail">
              <div class="detail-label">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</div>
              <div class="detail-value">${c.duration ? c.duration + ' ‡∏ô‡∏≤‡∏ó‡∏µ' : '-'}</div>
            </div>
            <div class="charge-detail">
              <div class="detail-label">‡∏ø/kWh</div>
              <div class="detail-value">${c.kwh > 0 ? formatNumber(c.cost / c.kwh) : '-'}</div>
            </div>
          </div>
          ${c.note ? `<div style="margin-top:8px;font-size:0.75rem;color:#64748b">${escapeHtml(c.note)}</div>` : ''}
          <div class="charge-card-actions">
            <button class="btn-delete" onclick="deleteCharge('${c.id}')">‡∏•‡∏ö</button>
          </div>
        </div>
      `).join('');
    }

    function updateStats(charges) {
      const total = charges.length;
      const totalCost = charges.reduce((sum, c) => sum + (c.cost || 0), 0);
      const totalKwh = charges.reduce((sum, c) => sum + (c.kwh || 0), 0);
      const avgCost = totalKwh > 0 ? totalCost / totalKwh : 0;

      document.getElementById('totalCharges').textContent = total;
      document.getElementById('totalCost').textContent = formatNumber(totalCost) + ' ‡∏ø';
      document.getElementById('totalKwh').textContent = formatNumber(totalKwh);
      document.getElementById('avgCostPerKwh').textContent = formatNumber(avgCost) + ' ‡∏ø';
    }

    // ‚îÄ‚îÄ‚îÄ Delete ‚îÄ‚îÄ‚îÄ
    async function deleteCharge(id) {
      if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ?')) return;

      try {
        await userChargesRef().doc(id).delete();
        showToast('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß');
        loadCharges();
      } catch (err) {
        showToast('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message, true);
      }
    }

    // ‚îÄ‚îÄ‚îÄ Month Filter ‚îÄ‚îÄ‚îÄ
    function setDefaultMonth() {
      const now = new Date();
      const month = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
      document.getElementById('monthFilter').value = month;
    }

    function filterByMonth() {
      const month = document.getElementById('monthFilter').value;
      if (!month) return;

      const filtered = allCharges.filter(c => c.date && c.date.startsWith(month));
      renderCharges(filtered);
      updateStats(filtered);
    }

    function clearFilter() {
      renderCharges(allCharges);
      updateStats(allCharges);
    }

    // ‚îÄ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ
    function formatDate(dateStr) {
      if (!dateStr) return '-';
      try {
        const d = new Date(dateStr + 'T00:00:00');
        return d.toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric' });
      } catch {
        return dateStr;
      }
    }

    function formatNumber(num) {
      if (typeof num !== 'number' || isNaN(num)) return '0';
      return num.toLocaleString('th-TH', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function showToast(msg, isError = false) {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.className = 'toast' + (isError ? ' error' : '');
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }
  </script>
</body>
</html>
